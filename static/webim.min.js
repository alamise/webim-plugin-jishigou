(function(y,B,la){function ya(e){return za.call(e)==="[object Function]"}function ra(e){return za.call(e)==="[object Array]"}function Ea(e){return e&&za.call(e)==="[object Object]"}function Aa(e){return(e||"").replace(/^\s+|\s+$/g,"")}function sa(e,h){var k=false;if(Ea(h)){e=e||{};for(var l in h){var p=h[l];if(e[l]!=p){k=k||{};k[l]=p}}}return k}function ma(e){var h=[];if(e!=null){var k=e.length;if(k==null||typeof e==="string"||ya(e)||e.setInterval)h[0]=e;else for(;k;)h[--k]=e[k]}return h}function D(){var e=
arguments[0]||{},h=1,k=arguments.length,l=false,p;if(typeof e==="boolean"){l=e;e=arguments[1]||{};h=2}if(typeof e!=="object"&&!ya(e))e={};for(;h<k;h++)if((p=arguments[h])!=null)for(var v in p){var t=e[v],u=p[v];if(e!==u)if(l&&u&&typeof u==="object"&&!u.nodeType)e[v]=D(l,t||(u.length!=null?[]:{}),u);else if(u!==la)e[v]=u}return e}function K(e,h,k){var l,p=0,v=e.length,t=v===la||ya(e);if(k)if(t)for(l in e){if(h.apply(e[l],k)===false)break}else for(;p<v;){if(h.apply(e[p++],k)===false)break}else if(t)for(l in e){if(h.call(e[l],
l,e[l])===false)break}else for(k=e[0];p<v&&h.call(k,p,k)!==false;k=e[++p]);return e}function ka(e,h,k){for(var l=[],p=0,v=e.length;p<v;p++)!k!==!h(e[p],p)&&l.push(e[p]);return l}function ua(e,h){for(var k=[],l,p=0,v=e.length;p<v;p++){l=h(e[p],p);if(l!=null)k[k.length]=l}return k.concat.apply([],k)}function fa(e){this.type=e;this.timeStamp=(new Date).getTime()}function O(e){this.URL=e;this._setting();this._connect()}function A(e,h){var k=this;h=h||{};var l=k.ws=new WebSocket(e);l.onopen=function(){k.trigger("open",
"success");l.send("subscribe "+h.domain+" "+h.ticket)};l.onclose=function(p){k.trigger("close",[p.data])};l.onmessage=function(p){p=p.data;try{p=p?y.JSON&&y.JSON.parse?y.JSON.parse(p):(new Function("return "+p))():p}catch(v){}k.trigger("message",[p])};l.onerror=function(){k.trigger("error",[])}}function oa(e,h,k){if(typeof h!="undefined"){k=k||{};if(h===null){h="";k.expires=-1}var l="";if(k.expires&&(typeof k.expires=="number"||k.expires.toUTCString)){if(typeof k.expires=="number"){l=new Date;l.setTime(l.getTime()+
k.expires*24*60*60*1E3)}else l=k.expires;l="; expires="+l.toUTCString()}var p=k.path?"; path="+k.path:"",v=k.domain?"; domain="+k.domain:"";k=k.secure?"; secure":"";B.cookie=[e,"=",encodeURIComponent(h),l,p,v,k].join("")}else{h=null;if(B.cookie&&B.cookie!=""){k=B.cookie.split(";");for(l=0;l<k.length;l++){p=Aa(k[l]);if(p.substring(0,e.length+1)==e+"="){h=decodeURIComponent(p.substring(e.length+1));break}}}return h}}function J(e,h){this.options=D({},J.defaults,h);this._init(e,h)}function z(e){return e&&
e.split?e.split(","):ra(e)?e:parseInt(e)?[parseInt(e)]:[]}function na(e,h,k){function l(p,v){this.data=p;this.options=D({},l.defaults,v);ya(this._init)&&this._init()}l.defaults=h;fa.on(l);D(l.prototype,k);J[e]=l}function I(e,h){if(typeof e=="string"){e[e]=h;if(h===la)return I[e]}D(I,e)}var za=Object.prototype.toString;fa.on=function(){for(var e,h=fa.on.prototype,k=0,l=arguments.length;k<l;k++){e=arguments[k].prototype;e.bind=e.addEventListener=h.addEventListener;e.unbind=e.removeEventListener=h.removeEventListener;
e.trigger=e.dispatchEvent=h.dispatchEvent}};fa.on.prototype={addEventListener:function(e,h){var k=this.__listeners=this.__listeners||{};k[e]=k[e]||[];k[e].push(h);return this},dispatchEvent:function(e,h){var k=this.__listeners=this.__listeners||{};e=e.type?e:new fa(e);k=k[e.type];if(Object.prototype.toString.call(h)==="[object Array]")h.unshift(e);else h=[e,h];if(k)for(var l=0,p=k.length;l<p;l++)k[l].apply(this,h);return this},removeEventListener:function(e,h){var k=this.__listeners=this.__listeners||
{};if(k[e])if(h){k=k[e];for(var l=k.length;l--;)k[l]===h&&k.splice(l,1)}else delete k[e];return this}};var W=function(){function e(x){var n={};for(var G in e.settings)n[G]=e.settings[G];if(x)for(G in x)n[G]=x[G];if(n.dataType==="jsonp")n.type="GET";var P,$,aa,E=n.type.toUpperCase(),H=p.test(E),S,X,Ga=y,Y;n.url=n.url.replace(ca,"");n.context=x&&x.context!=null?x.context:n;if(n.data&&n.processData&&typeof n.data!=="string")n.data=h(n.data,n.traditional);var ga=N.exec(n.url);G=y.location;ga=ga&&(ga[1]&&
ga[1]!==G.protocol||ga[2]!==G.host);/https?:/i.test(G.protocol)||(ga=false);ga=n.forceRemote?true:ga;if(n.dataType==="jsonp"&&!ga)n.dataType="json";if(n.dataType==="jsonp"){if(E==="GET")t.test(n.url)||(n.url+=(u.test(n.url)?"&":"?")+(n.jsonp||"callback")+"=?");else if(!n.data||!t.test(n.data))n.data=(n.data?n.data+"&":"")+(n.jsonp||"callback")+"=?";n.dataType="json"}if(n.dataType==="json"&&(n.data&&t.test(n.data)||t.test(n.url))){P=n.jsonpCallback||"jsonp"+k++;if(n.data)n.data=(n.data+"").replace(t,
"="+P+"$1");n.url=n.url.replace(t,"="+P+"$1");n.dataType="script";var Ba=y[P],ta=false;y[P]=function(ia){if(!ta){ta=true;if(Object.prototype.toString.call(Ba)==="[object Function]")Ba(ia);else{y[P]=la;try{delete y[P]}catch(va){}}aa=ia;M.handleSuccess(n,F,$,aa);M.handleComplete(n,F,$,aa);S&&S.removeChild(Y);X&&X.parentNode&&X.parentNode.removeChild(X)}}}if(n.dataType==="script"&&n.cache===null)n.cache=false;if(n.cache===false&&E==="GET"){var Ca=(new Date).getTime(),Fa=n.url.replace(L,"$1_="+Ca);n.url=
Fa+(Fa===n.url?(u.test(n.url)?"&":"?")+"_="+Ca:"")}if(n.data&&E==="GET")n.url+=(u.test(n.url)?"&":"?")+n.data;n.global&&M.active++;if(n.dataType==="script"&&E==="GET"&&ga){x=false;if(P&&n.async&&!l)if(y._fragmentProxy)S=X=B.createDocumentFragment();else{x=true;if(n.url.slice(0,1)=="/")n.url=G.protocol+"//"+G.host+(G.port?":"+G.port:"")+n.url;else if(!/^https?:\/\//i.test(n.url)){G=G.href;E=/([^?#]+)\//.exec(G);n.url=(E?E[1]:G)+"/"+n.url}n.url=n.url.replace("="+P,"=parent."+P);X=B.createElement("iframe");
X.style.position="absolute";X.style.left="-100px";X.style.top="-100px";X.style.height="1px";X.style.width="1px";X.style.visibility="hidden";B.body.insertBefore(X,B.body.firstChild);Ga=X.contentWindow}var pa=function(){var ia=Ga.document;S=S||ia.getElementsByTagName("head")[0]||ia.documentElement;Y=ia.createElement("script");if(n.scriptCharset)Y.charset=n.scriptCharset;Y.src=n.url;if(l)Y.async=n.async;if(P)Y.onload=Y.onerror=Y.onreadystatechange=function(){if(!ta&&(!this.readyState||this.readyState===
"loaded"||this.readyState==="complete")){ta=true;M.handleError(n,F,"error","load error");S&&Y.parentNode&&S.removeChild(Y);X&&X.parentNode&&X.parentNode.removeChild(X)}};else{var va=false;Y.onload=Y.onreadystatechange=function(){if(!va&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){va=true;M.handleSuccess(n,F,$,aa);M.handleComplete(n,F,$,aa);Y.onload=Y.onreadystatechange=null;S&&Y.parentNode&&S.removeChild(Y)}}}S.insertBefore(Y,S.firstChild)};x?setTimeout(function(){pa()},
0):pa();return la}var wa=false,F=n.xhr();if(F){n.username?F.open(E,n.url,n.async,n.username,n.password):F.open(E,n.url,n.async);try{if(n.data!=null&&!H||x&&x.contentType)F.setRequestHeader("Content-Type",n.contentType);if(n.ifModified){M.lastModified[n.url]&&F.setRequestHeader("If-Modified-Since",M.lastModified[n.url]);M.etag[n.url]&&F.setRequestHeader("If-None-Match",M.etag[n.url])}ga||F.setRequestHeader("X-Requested-With","XMLHttpRequest");F.setRequestHeader("Accept",n.dataType&&n.accepts[n.dataType]?
n.accepts[n.dataType]+", */*; q=0.01":n.accepts._default)}catch(Ia){}if(n.beforeSend&&n.beforeSend.call(n.context,F,n)===false){n.global&&M.active--;F.abort();return false}n.global&&M.triggerGlobal(n,"ajaxSend",[F,n]);var ja=F.onreadystatechange=function(ia){if(!F||F.readyState===0||ia==="abort"){wa||M.handleComplete(n,F,$,aa);wa=true;if(F)F.onreadystatechange=M.noop}else if(!wa&&F&&(F.readyState===4||ia==="timeout")){wa=true;F.onreadystatechange=M.noop;$=ia==="timeout"?"timeout":!M.httpSuccess(F)?
"error":n.ifModified&&M.httpNotModified(F,n.url)?"notmodified":"success";var va;if($==="success")try{aa=M.httpData(F,n.dataType,n)}catch(a){$="parsererror";va=a}if($==="success"||$==="notmodified")P||M.handleSuccess(n,F,$,aa);else M.handleError(n,F,$,va);P||M.handleComplete(n,F,$,aa);ia==="timeout"&&F.abort();if(n.async)F=null}};try{var T=F.abort;F.abort=function(){F&&T.call&&T.call(F);ja("abort")}}catch(ea){}n.async&&n.timeout>0&&setTimeout(function(){F&&!wa&&ja("timeout")},n.timeout);try{F.send(H||
n.data==null?null:n.data)}catch(Ha){M.handleError(n,F,null,Ha);M.handleComplete(n,F,$,aa)}n.async||ja();return F}}function h(x){var n=[];if(typeof x=="object"){for(var G in x)n[n.length]=encodeURIComponent(G)+"="+encodeURIComponent(x[G]);return n.join("&").replace(Q,"+")}return x}var k=(new Date).getTime(),l=typeof B.createElement("script").async==="boolean",p=/^(?:GET|HEAD|DELETE)$/,v=/\S/,t=/\=\?(&|$)/,u=/\?/,L=/([?&])_=[^&]*/,N=/^(\w+:)?\/\/([^\/?#]+)/,Q=/%20/g,ca=/#.*$/;y._fragmentProxy=false;
var V=B.createDocumentFragment(),ha=B.createElement("script");try{ha.appendChild(B.createTextNode("window._fragmentProxy = true"))}catch(xa){ha.text="window._fragmentProxy = true"}V.appendChild(ha);V=ha=null;e.param=h;var M={noop:function(){},active:0,lastModified:{},etag:{},handleError:function(x,n,G,P){x.error&&x.error.call(x.context,n,G,P);x.global&&M.triggerGlobal(x,"ajaxError",[n,x,P])},handleSuccess:function(x,n,G,P){x.success&&x.success.call(x.context,P,G,n);x.global&&M.triggerGlobal(x,"ajaxSuccess",
[n,x])},handleComplete:function(x,n,G){x.complete&&x.complete.call(x.context,n,G);x.global&&M.triggerGlobal(x,"ajaxComplete",[n,x]);x.global&&M.active--},triggerGlobal:function(){},httpSuccess:function(x){try{return!x.status&&location.protocol==="file:"||x.status>=200&&x.status<300||x.status===304||x.status===1223}catch(n){}return false},httpNotModified:function(x,n){var G=x.getResponseHeader("Last-Modified"),P=x.getResponseHeader("Etag");if(G)M.lastModified[n]=G;if(P)M.etag[n]=P;return x.status===
304},httpData:function(x,n,G){var P=x.getResponseHeader("content-type")||"",$=n==="xml"||!n&&P.indexOf("xml")>=0;x=$?x.responseXML:x.responseText;$&&x.documentElement.nodeName==="parsererror"&&M.error("parsererror");if(G&&G.dataFilter)x=G.dataFilter(x,n);if(typeof x==="string")if(n==="json"||!n&&P.indexOf("json")>=0)x=x?y.JSON&&y.JSON.parse?y.JSON.parse(x):(new Function("return "+x))():x;else if(n==="script"||!n&&P.indexOf("javascript")>=0)if(x&&v.test(x)){n=B.getElementsByTagName("head")[0]||B.documentElement;
G=B.createElement("script");G.type="text/javascript";try{G.appendChild(B.createTextNode(x))}catch(aa){G.text=x}n.insertBefore(G,n.firstChild);n.removeChild(G)}return x}};e.settings={url:location.href,global:true,type:"GET",contentType:"application/x-www-form-urlencoded",processData:true,async:true,xhr:function(){return new y.XMLHttpRequest},accepts:{xml:"application/xml, text/xml",html:"text/html",script:"text/javascript, application/javascript",json:"application/json, text/javascript",text:"text/plain",
_default:"*/*"}};e.setup=function(x){if(x)for(var n in x)e.settings[n]=x[n]};if(y.ActiveXObject)e.settings.xhr=function(){if(y.location.protocol!=="file:")try{return new y.XMLHttpRequest}catch(x){}try{return new y.ActiveXObject("Microsoft.XMLHTTP")}catch(n){}};return e}(),qa=y.JSON?y.JSON:function(){function e(l){return k[l]||"\\u00"+Math.floor(l.charCodeAt()/16).toString(16)+(l.charCodeAt()%16).toString(16)}function h(l){switch(Object.prototype.toString.call(l)){case "[object String]":return'"'+
l.replace(/[\x00-\x1f\\"]/g,e)+'"';case "[object Array]":for(var p=[],v=l.length,t=0;t<v;t++)p.push(h(l[t]));return"["+p.join(",")+"]";case "[object Object]":p=[];for(v in l)(t=h(l[v]))&&p.push(h(v)+":"+t);return"{"+p+"}";case "[object Number]":case "[object Boolean]":return String(l);case false:return"null"}return null}var k={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return{stringify:h,parse:function(l){l=l.toString();if(!l||!l.length)return null;return(new Function("return "+
l))()}}}();O.prototype={readyState:0,send:function(){},_setting:function(){this.readyState=O.CLOSED;this._onPolling=this._connecting=false;this._pollTimer=null;this._failTimes=this._pollingTimes=0},_connect:function(){var e=this;if(e._connecting)return e;e.readyState=O.CONNECTING;e._connecting=true;e._onPolling||y.setTimeout(function(){e._startPolling()},300);return e},close:function(){this._pollTimer&&clearTimeout(this._pollTimer);this._setting();return this},_onConnect:function(){this.readyState=
O.OPEN;this.trigger("open","success")},_onClose:function(e){var h=this;h._setting();setTimeout(function(){h.trigger("close",[e])},1E3)},_onData:function(e){this.trigger("message",[e])},_onError:function(e){var h=this;h._setting();setTimeout(function(){h.trigger("error",[e])},1E3)},_startPolling:function(){if(this._connecting){this._onPolling=true;this._pollingTimes++;W({url:this.URL,dataType:"jsonp",cache:false,context:this,success:this._onPollSuccess,error:this._onPollError})}},_onPollSuccess:function(e){var h=
this;h._onPolling=false;if(h._connecting)if(e){h._pollingTimes==1&&h._onConnect();h._onData(e);h._failTimes=0;h._pollTimer=y.setTimeout(function(){h._startPolling()},200)}else return h._onError("error data")},_onPollError:function(e){var h=this;h._onPolling=false;if(h._connecting){h._failTimes++;if(h._pollingTimes==1)h._onError("can not connect.");else if(h._failTimes>1)h._onClose(e);else h._pollTimer=y.setTimeout(function(){h._startPolling()},200)}}};O.CONNECTING=0;O.OPEN=1;O.CLOSED=2;fa.on(O);A.prototype=
{readyState:0,send:function(){},close:function(){this.ws.close()}};A.enable=!!y.WebSocket;A.CONNECTING=0;A.OPEN=1;A.CLOSED=2;fa.on(A);fa.on(J);J.csrf_token="";J.OFFLINE=0;J.BEFOREONLINE=1;J.ONLINE=2;D(J.prototype,{state:J.OFFLINE,_init:function(){var e=this.options;this.data={user:{presence:"offline",show:"unavailable"}};W.settings.dataType=e.jsonp?"jsonp":"json";this.status=new J.status;this.setting=new J.setting;this.buddy=new J.buddy;this.room=new J.room(null,this.data);this.history=new J.history(null,
this.data);this._initEvents()},_createConnect:function(){var e=this,h=e.data.connection;e.connection=e.options.connectionType!="jsonpd"&&h.websocket&&A.enable?new A(h.websocket,h):new O(h.server+(/\?/.test(h)?"&":"?")+W.param({ticket:h.ticket,domain:h.domain}));e.connection.bind("connect",function(){}).bind("message",function(k,l){e.handle(l)}).bind("error",function(){e._stop("connect","Connect Error")}).bind("close",function(){e._stop("connect","Disconnect")})},setUser:function(e){D(this.data.user,
e)},_ready:function(e){this.state=J.BEFOREONLINE;this.trigger("beforeOnline",[e])},_go:function(){var e=this.data,h=this.history,k=this.buddy,l=this.room;this.state=J.ONLINE;h.options.userInfo=e.user;K(e.buddies,function(v,t){h.init("chat",t.id,t.history)});k.set(e.buddies);K(e.rooms,function(v,t){h.init("grpchat",t.id,t.history)});k=this.setting.get("blocked_rooms");var p=e.rooms;ra(k)&&p&&K(k,function(v,t){p[t]&&(p[t].blocked=true)});l.set(p);l.options.ticket=e.connection.ticket;this.trigger("online",
[e]);this._createConnect();l=[];if(e.new_messages)l=l.concat(e.new_messages);if(e.offline_messages)l=l.concat(e.offline_messages);if(l&&l.length){K(l,function(v,t){t["new"]=true});this.trigger("message",[l])}},_stop:function(e,h){if(this.state!==J.OFFLINE){this.state=J.OFFLINE;this.data.user.presence="offline";this.data.user.show="unavailable";this.buddy.clear();this.room.clear();this.history.clean();this.trigger("offline",[e,h])}},autoOnline:function(){return!this.status.get("o")},_initEvents:function(){function e(u){var L=
{id:u.from,presence:u.type};if(u.show)L.show=u.show;if(u.nick)L.nick=u.nick;if(u.status)L.status=u.status;return L}function h(u){return u.type=="online"||u.type=="offline"||u.type=="show"}function k(u){return u.type=="join"||u.type=="leave"}var l=this,p=l.history,v=l.buddy,t=l.room;l.bind("message",function(u,L){for(var N=[],Q=L.length,ca=l.data.user.id,V,ha,xa,M=0;M<Q;M++){V=L[M];xa=V.type;ha=xa=="chat"?V.to==ca?V.from:V.to:V.to;V.id=ha;if(xa=="chat"&&!V["new"]){ha={id:ha,presence:"online"};if(V.nick&&
V.to==ca)ha.nick=V.nick;N.push(ha)}}if(N.length){v.presence(N);v.complete()}p.set(L)});l.bind("presence",function(u,L){v.presence(ua(ka(L,h),e));L=ka(L,k);for(var N=L.length-1;N>=0;N--){var Q=L[N];Q.type=="leave"?t.removeMember(Q.to||Q.status,Q.from):t.addMember(Q.to||Q.status,{id:Q.from,nick:Q.nick})}})},handle:function(e){if(e.messages&&e.messages.length){for(var h=e.messages,k=[],l=[],p=0;p<h.length;p++){var v=h[p];if(v.body&&v.body.indexOf("webim-event:")==0){v.event=v.body.replace("webim-event:",
"").split("|,|");l.push(v)}else k.push(v)}k.length&&this.trigger("message",[k]);l.length&&this.trigger("event",[l])}e.presences&&e.presences.length&&this.trigger("presence",[e.presences]);e.statuses&&e.statuses.length&&this.trigger("status",[e.statuses])},sendMessage:function(e,h){e.ticket=this.data.connection.ticket;this.trigger("sendMessage",[e]);W({type:"post",cache:false,url:I("message"),data:D({csrf_token:J.csrf_token},e),success:h,error:h})},sendStatus:function(e,h){e.ticket=this.data.connection.ticket;
this.trigger("sendStatus",[e]);W({type:"post",cache:false,url:I("status"),data:D({csrf_token:J.csrf_token},e),success:h,error:h})},sendPresence:function(e,h){e.ticket=this.data.connection.ticket;this.data.user.show=e.show;this.status.set("s",e.show);this.trigger("sendPresence",[e]);W({type:"post",cache:false,url:I("presence"),data:D({csrf_token:J.csrf_token},e),success:h,error:h})},online:function(e){var h=this,k=h.status;if(h.state===J.OFFLINE){var l=[],p=[],v=k.get("tabs"),t=k.get("tabIds");t&&
t.length&&v&&K(v,function(u){u[0]=="b"&&l.push(u.slice(2));u[0]=="r"&&p.push(u.slice(2))});e=D({buddy_ids:l.join(","),room_ids:p.join(","),csrf_token:J.csrf_token,show:k.get("s")||"available"},e);h._ready(e);k.set("o",false);k.set("s",e.show);W({type:"post",cache:false,url:I("online"),data:e,success:function(u){if(u)if(u.success){u.user=D(h.data.user,u.user,{presence:"online"});h.data=u;h._go()}else h._stop("online",u.error_msg);else h._stop("online","Not Found")},error:function(){h._stop("online",
"Not Found")}})}},offline:function(){var e=this.data;if(this.state!==J.OFFLINE){this.status.set("o",true);this.connection.close();this._stop("offline","offline");W({type:"post",cache:false,url:I("offline"),data:{status:"offline",csrf_token:J.csrf_token,ticket:e.connection.ticket}})}},_deactivate:function(){var e=this.data;!e||!e.connection||!e.connection.ticket||W({type:"get",cache:false,url:I("deactivate"),data:{ticket:e.connection.ticket,csrf_token:J.csrf_token}})}});y.webim=J;D(J,{version:"5.3",
defaults:{},log:function(){var e=new Date;["[",e.getHours(),":",e.getMinutes(),":",e.getSeconds(),"-",e.getMilliseconds(),"]"].join("");if(y&&y.console)y.console.log.apply(null,arguments);else y&&y.runtime&&y.air&&y.air.Introspector&&y.air.Introspector.Console.log.apply(null,arguments)},idsArray:z,now:function(){return(new Date).getTime()},isFunction:ya,isArray:ra,isObject:Ea,trim:Aa,makeArray:ma,extend:D,each:K,inArray:function(e,h){for(var k=0,l=h.length;k<l;k++)if(h[k]===e)return k;return-1},grep:ka,
map:ua,JSON:qa,ajax:W,comet:O,socket:A,model:na,route:I,ClassEvent:fa});na("setting",{data:{play_sound:true,buddy_sticky:true,minimize_layout:true,msg_auto_pop:true,temporary_rooms:[],blocked_rooms:[]}},{_init:function(){this.data=D({},this.options.data,this.data)},get:function(e){return this.data[e]},set:function(e,h){var k=this,l=e;if(e){if(typeof e=="string"){l={};l[e]=h}var p=k.data,v=sa(p,l);if(v){K(v,function(t,u){k.trigger("update",[t,u])});l=D({},p,l);k.data=l;W({type:"post",url:I("setting"),
cache:false,data:{data:qa.stringify(l),csrf_token:J.csrf_token}})}}}});na("status",{key:"_webim"},{_init:function(){var e=this.data,h=this.options.key,k=y.localStorage;if(k)try{k.setItem("__store_webim__","__store_webim__");if(k.getItem("__store_webim__")=="__store_webim__")this.store=k;k.removeItem("__store_webim__")}catch(l){this.store=la}if(e)this._save(e);else this.data=(e=this.store?this.store.getItem(h):oa(h))?qa.parse(e):{}},set:function(e,h){var k=e;if(typeof e=="string"){k={};k[e]=h}var l=
this.data;sa(l,k)&&this._save(D({},l,k))},get:function(e){return this.data[e]},clear:function(){this._save({})},_save:function(e){var h=this.options.key;this.data=e;e=qa.stringify(e);this.store?this.store.setItem(h,e):oa(h,e,{path:"/",domain:B.domain})}});na("buddy",{active:true},{_init:function(){this.data=this.data||[];this.dataHash={};this.set(this.data)},clear:function(){this.data=[];this.dataHash={}},count:function(e){var h=this.dataHash,k=0,l;for(var p in h)if(Ea(e)){l=true;for(var v in e)if(e[v]!=
h[p][v])l=false;l&&k++}else k++;return k},get:function(e){return this.dataHash[e]},all:function(e){return e?ka(this.data,function(h){return h.show!="invisible"&&h.presence=="online"}):this.data},complete:function(){var e=this.dataHash,h=[],k;for(var l in e){k=e[l];if(k.incomplete){k.incomplete=false;h.push(l)}}this.load(h)},update:function(e){this.load(e)},presence:function(e){var h=this.dataHash;e=ra(e)?e:[e];for(var k in e){var l=e[k];l.presence=l.presence=="offline"?"offline":"online";l.incomplete=
!h[l.id];if(!l.group&&l.id)l.group=l.id.indexOf("vid:")==0?"visitor":l.group}this.set(e)},load:function(e){e=z(e);e.length&&W({type:"get",url:I("buddies"),cache:false,data:{ids:e.join(","),csrf_token:J.csrf_token},context:this,success:this.set})},set:function(e){var h=this.data,k=this.dataHash,l={};e=e||[];var p,v;for(var t in e){p=e[t];if(id=p.id){if(!k[id]){p.presence=p.presence||"online";p.show=p.show?p.show:p.presence=="offline"?"unavailable":"available";k[id]={};h.push(k[id])}p.incomplete=!!p.incomplete;
if(v=sa(k[id],p)){p=v.presence||"update";l[p]=l[p]||[];D(k[id],v);l[p].push(k[id])}}}for(var u in l)this.trigger(u,[l[u]]);this.options.active&&this.complete()}});(function(){na("room",{},{_init:function(){this.data=this.data||[];this.dataHash={}},get:function(e){return this.dataHash[e]},all:function(e){return e?ka(this.data,function(h){return h.temporary}):this.data},block:function(e){var h=this.dataHash[e];if(h&&!h.blocked){h.blocked=true;var k=[];K(this.dataHash,function(l,p){!p.temporary&&p.blocked&&
k.push(p.id)});this.trigger("block",[e,k])}},unblock:function(e){var h=this.dataHash[e];if(h&&h.blocked){h.blocked=false;var k=[];K(this.dataHash,function(l,p){!p.temporary&&p.blocked&&k.push(p.id)});this.trigger("unblock",[e,k])}},set:function(e){var h=this,k=h.data,l=h.dataHash;K(e,function(p,v){var t=v.id;if(t){v.members=v.members||[];v.count=v.count||0;v.all_count=v.all_count||0;if(l[t])D(l[t],v);else{l[t]=v;k.push(v)}h.trigger("join",[l[t]])}})},addMember:function(e,h){var k=this;if(ra(h))K(h,
function(u,L){k.addMember(e,L)});else{var l=k.dataHash[e];if(l){for(var p=l.members,v,t=p.length;t--;)if(p[t].id==h.id)v=p[t];if(!v){h.nick=h.nick;p.push(h);l.count=p.length;k.trigger("addMember",[e,h])}}}},removeMember:function(e,h){var k=this.dataHash[e];if(k){for(var l=k.members,p,v=l.length;v--;)if(l[v].id==h){p=l[v];l.splice(v,1);k.count--}p&&this.trigger("removeMember",[e,p])}},initMember:function(e){var h=this.dataHash[e];if(h&&!h.initMember){h.initMember=true;this.loadMember(e)}},loadMember:function(e){var h=
this,k=h.options;W({type:"get",cache:false,url:I("members"),data:{ticket:k.ticket,id:e,csrf_token:J.csrf_token},success:function(l){h.addMember(e,l)}})},join:function(e,h,k){var l=this,p=l.options;W({type:"post",cache:false,url:I("join"),data:{ticket:p.ticket,id:e,nick:h||"",csrf_token:J.csrf_token},success:function(v){l.initMember(e);l.set([v]);k&&k(v)}})},leave:function(e){var h=this.options,k=this.dataHash[e],l=h.user;if(k){k.initMember=false;W({type:"post",cache:false,url:I("leave"),data:{ticket:h.ticket,
id:e,nick:l.nick,csrf_token:J.csrf_token}});this.trigger("leave",[k])}},clear:function(){this.data=[];this.dataHash={}}})})();na("history",{},{_init:function(){this.data=this.data||{};this.data.chat=this.data.chat||{};this.data.grpchat=this.data.grpchat||{}},clean:function(){this.data.chat={};this.data.grpchat={}},get:function(e,h){return this.data[e][h]},set:function(e){var h=this.data,k={chat:{},grpchat:{}};e=ma(e);var l=e.length,p,v,t=this.options.userInfo.id;if(l){for(var u=0;u<l;u++){p=e[u];
L=p.type;if((v=L=="chat"?p.to==t?p.from:p.to:p.to)&&L){k[L][v]=k[L][v]||[];k[L][v].push(p)}}for(var L in k)for(v in k[L]){p=k[L][v];if(h[L][v]){h[L][v]=h[L][v].concat(p);this._triggerMsg(L,v,p)}else this.load(L,v)}}},_triggerMsg:function(e,h,k){this.trigger(e,[h,k])},clear:function(e,h){this.data[e][h]=[];this.trigger("clear",[e,h]);W({url:I("clear"),type:"post",cache:false,data:{type:e,id:h,csrf_token:J.csrf_token}})},download:function(e,h){var k=I("download"),l=B.createElement("iframe"),p=new Date,
v=[];p={id:h,type:e,time:(new Date).getTime(),date:p.getFullYear()+"-"+(p.getMonth()+1)+"-"+p.getDate()};for(var t in p)v[v.length]=encodeURIComponent(t)+"="+encodeURIComponent(p[t]);k+=(/\?/.test(k)?"&":"?")+v.join("&");l.setAttribute("src",k);l.style.display="none";B.body.appendChild(l)},init:function(e,h,k){if(ra(k)){this.data[e][h]=k;this._triggerMsg(e,h,k)}},load:function(e,h){var k=this;k.data[e][h]=[];W({url:I("history"),cache:false,type:"get",data:{type:e,id:h,csrf_token:J.csrf_token},success:function(l){k.init(e,
h,l)}})}})})(window,document);
(function(y,B,la){function ya(){return false}function ra(a){var b="";if(a.length==0)return"";b=a.replace(/&/g,"&amp;");b=b.replace(/</g,"&lt;");b=b.replace(/>/g,"&gt;");b=b.replace(/    /g,"&nbsp;");b=b.replace(/\'/g,"&#39;");b=b.replace(/\"/g,"&quot;");return b=b.replace(/\n/g,"<br />")}function Ea(a){return/^http:\/\/[A-Za-z0-9]+\.[A-Za-z0-9]+[\/=\?%\-&_~`@[\]\':+!]*([^<>\"])*$/.test(a)}function Aa(a){return a?a.replace(/<(?:.|\s)*?>/g,""):""}function sa(a,b){for(var c=[];a;a=a.nextSibling)a.nodeType==
1&&a!=b&&c.push(a);return c}function ma(a,b){return a&&RegExp("(^|\\s+)"+b+"(\\s+|$)").test(a.className)}function D(a,b){if(a)ma(a,b)||(a.className+=" "+b)}function K(a,b){a&&(a.className=a.className.replace(RegExp("(^|\\s+)("+b.split(/\s+/).join("|")+")(?=(\\s+|$))","g")," "))}function ka(a,b,c){a&&(a.className=a.className.replace(RegExp("(^|\\s+)("+b.split(/\s+/).join("|")+")(?=(\\s+|$))","g")," ")+" "+c)}function ua(a,b,c){z(a,"mouseover",function(){D(this,b);c&&K(this,c)});z(a,"mouseout",function(){K(this,
b);c&&D(this,c)})}function fa(a,b,c){if(typeof c==="boolean")c?D(a,b):K(a,b);else ma(a,b)?K(a,b):D(a,b)}function O(a){a&&a.style&&(a.style.display="block")}function A(a){a&&a.style&&(a.style.display="none")}function oa(a){a&&a.parentNode&&a.parentNode.removeChild(a)}function J(a,b){var c=a.childNodes;for(i=0;i<c.length;i++)a.removeChild(c[i]);typeof b==="string"?a.innerHTML=b:a.appendChild(b)}function z(a,b,c){if(a.addEventListener)a.addEventListener(b,c,false);else{a["e"+b+c]=c;a[b+c]=function(){return a["e"+
b+c](y.event)};a.attachEvent("on"+b,a[b+c])}}function na(a){if(a){a.stopPropagation&&a.stopPropagation();a.cancelBubble=true}}function I(a){if(a){a.preventDefault&&a.preventDefault();a.returnValue=false}}function za(a){if(!a.target)a.target=a.srcElement||B;if(a.target.nodeType===3)a.target=a.target.parentNode;return a.target}function W(a){a.setAttribute("unselectable","on");a.style.MozUserSelect="none";a.style.OUserSelect="none";a.style.WebkitUserSelect="none";z(a,"selectstart",ya)}function qa(){if(!ta){ta=
true;if(Ca){for(var a,b=0;a=Ca[b++];)a();Ca=null}}}function e(){if(!Fa){Fa=true;if(B.readyState==="complete")return qa();if(B.addEventListener)B.addEventListener("DOMContentLoaded",function(){B.removeEventListener("DOMContentLoaded",arguments.callee,false);qa()},false);else if(B.attachEvent){B.attachEvent("onreadystatechange",function(){if(B.readyState==="complete"){B.detachEvent("onreadystatechange",arguments.callee);qa()}});B.documentElement.doScroll&&y==y.top&&function(){if(!ta){try{B.documentElement.doScroll("left")}catch(a){setTimeout(arguments.callee,
0);return}qa()}}()}z(y,"load",qa)}}function h(a){var b=new Date;b.setTime(a?parseFloat(a)+h.timeSkew:(new Date).getTime());this.date=b}function k(a,b,c){if(a.addEventListener)a.addEventListener(b,c,false);else{a["e"+b+c]=c;a[b+c]=function(){return a["e"+b+c](y.event)};a.attachEvent("on"+b,a[b+c])}}function l(a){a&&a.parentNode&&a.parentNode.removeChild(a)}function p(a){return a?y.JSON&&y.JSON.parse?y.JSON.parse(a):(new Function("return "+a))():a}function v(a,b){k(a,"submit",function(){function c(){try{var m=
f.contentWindow.name||null;if(m!=null){l(d);b&&b(p(m))}else throw Error("Empty data");}catch(o){l(d);b&&b({error:"Retrieve data error"})}}a.setAttribute("target","_upload_form13123");var d=B.createElement("div");d.innerHTML='<iframe name="_upload_form13123" id="_upload_form13123" style="display:none;" scrolling="no" frameborder="0"></iframe>';var f=d.firstChild;B.body.appendChild(d);if(y.postMessage){var g=function(m){var o=y,q=g;if(o.addEventListener)o.removeEventListener("message",q,false);else{o.detachEvent("onmessage",
o["message"+q]);o["message"+q]=null}l(d);b&&b(p(m.data))};k(y,"message",g)}else{var j=false;k(f,"load",function(){if(j)y.attachEvent||c();else{j=true;f.contentWindow.location="about:blank"}});if(y.attachEvent)f.onreadystatechange=function(){j&&c()}}})}function t(a,b,c){c=E({locale:t.locale},c);c=t.dictionary[c.locale];P(c)||(c={});a=c[a]===la?a:c[a];if(b){F=b;for(var d in b)a=a.replace(/\{\{(.*?)\}\}/g,Ia)}return a}function u(a,b){this.element=a;this.options=E({},u.defaults,b);this._init()}function L(a){a=
a.getElementsByTagName("*");for(var b,c,d={},f=a.length-1;f>-1;f--){b=a[f];if((c=b.id)&&c.indexOf(":")==0)d[c.substring(1,c.length)]=b}return d}function N(a){var b=B.createElement("div");b.innerHTML=a;return b=b.firstChild}function Q(a,b,c){function d(f,g){this.id=Ha++;this.name=a;this.className="webim-"+a;this.options=E({},d.defaults,g);if(this.element=f||this.template&&N(this.template())||this.options.template&&N(T(this.options.template))){this.options.className&&D(this.element,this.options.className);
this.$=L(this.element)}n(this._init)&&this._init();n(this._initEvents)&&this._initEvents()}d.defaults=b;Y.on(d);E(d.prototype,Q.prototype,c);u[a]=d}function ca(a,b){u.apps[a]=b||{}}function V(a,b){return b?a=="b"||a=="buddy"||a=="chat"?"b_"+b:"r_"+b:a}function ha(a){return a=="b"||a=="buddy"||a=="chat"?"buddy":"room"}function xa(){B.selection&&(this.caretPos=B.selection.createRange())}function M(){return"xx4xyxyxxxyxyyxy".replace(/[xy]/g,function(a){var b=Math.random()*16|0;return(a=="x"?b:b&3|8).toString(16)})}
var x=webim.idsArray,n=webim.isFunction,G=webim.isArray,P=webim.isObject,$=webim.trim,aa=webim.makeArray,E=webim.extend,H=webim.each,S=webim.grep,X=webim.ajax,Ga=webim.model,Y=webim.ClassEvent,ga=webim.route,Ba=webim.map,ta=false,Ca=[],Fa=false;h.timeSkew=0;h.init=function(a){h.timeSkew=(new Date).getTime()-parseFloat(a)};E(h.prototype,{getTime:function(){var a=this.date,b=a.getHours();a=a.getMinutes();if(a<10)a="0"+a;return b+":"+a+""},getDay:function(a){var b=this.date;if(a){a=new Date;a.setHours(0);
a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);a=a.getTime()-b.getTime();if(a<=0)return t("dt:today");else if(a<864E5)return t("dt:yesterday")}return t("dt:monthdate",{month:t(["dt:january","dt:february","dt:march","dt:april","dt:may","dt:june","dt:july","dt:august","dt:september","dt:october","dt:november","dt:december"][b.getMonth()]),date:b.getDate()})}});var pa=function(){var a=true,b={lib:"sound.swf",msg:"sound/msg.mp3"};return{enable:function(){a=true},disable:function(){a=false},init:function(c){E(b,
c);if(!y.Audio&&navigator.userAgent.indexOf("MSIE")>=0)B.getElementById("webim-flashlib-c").innerHTML='<bgsound id="webim-bgsound" src="#" autostart="true" loop="1">'},play:function(c){c=Ea(c)?c:b[c];if(a)if(y.Audio){if(!d)var d=new Audio;d.src=c;d.play()}else if(navigator.userAgent.indexOf("MSIE")>=0)try{B.getElementById("webim-bgsound").src=c?c:"/sound/sound.mp3"}catch(f){}}}}(),wa=function(){var a=false;z(y,"focus",function(){a=false});z(y,"blur",function(){a=true});var b=B.title,c=0,d=false;return function(f,
g){if(a){if(j){clearInterval(j);c=0;d=false}var j=setInterval(function(){c++;d=!d;if(c==g||!a){clearInterval(j);c=0;d=false}B.title=d?"["+f+"]"+b:b},1500)}}}(),F={},Ia=function(a,b){return F[b]||""};t.locale="zh-CN";t.dictionary={};t.store=function(a,b){var c=t.dictionary;P(c[a])||(c[a]={});E(c[a],b)};Y.on(u);E(u.prototype,{render:function(){var a=this,b=a.layout;a.element.insertBefore(b.element,a.element.firstChild);setTimeout(function(){a.initSound()},1E3);b.buildUI()},_init:function(){var a=this.im=
new webim(null,this.options.imOptions),b=this.options;this.layout=this.addApp(b.layout||"layout",b.layoutOptions);a.setting.get("play_sound")?pa.enable():pa.disable();a.bind("online",function(c,d){h.init(d.server_time)});a.setting.bind("update",function(c,d,f){if("play_sound"==d)f?pa.enable():pa.disable()})},addApp:function(a,b){var c=u.apps[a];if(c)return n(c)&&c.apply(this,[b])},initSound:function(a){pa.init(a||this.options.soundUrls)}});var ja=function(a,b){if(b===la)return parseInt(a.innerHTML);
else if(b){b=typeof b=="number"?b:parseInt(a.innerHTML)+parseInt(b);a.innerHTML=b.toString();O(a)}else{a.innerHTML="0";A(a)}return b},T=function(){function a(d,f){return b&&b[f]!=la?b[f]:t(f)}var b=null,c=/\<\%\=(.*?)\%\>/ig;return function(d,f){if(!d)return"";b=f;return d.replace(c,a)}}(),ea={add:function(a,b,c){a=u[a].prototype;for(var d in c){a.plugins[d]=a.plugins[d]||[];a.plugins[d].push([b,c[d]])}},call:function(a,b,c){if((b=a.plugins[b])&&a.element.parentNode)for(var d=0;d<b.length;d++)a.options[b[d][0]]&&
b[d][1].apply(a.element,c)}},Ha=1;E(Q.prototype,{_init:function(){}});E(u,{version:"5.1 ",widget:Q,app:ca,plugin:ea,i18n:t,date:h,ready:function(a){e();ta?a():Ca.push(a)},createElement:N,defaults:{},apps:{}});webim.ui=u;Q("window",{isMinimize:false,minimizable:true,maximizable:false,closeable:true,sticky:true,titleVisibleLength:12,count:0,template:'<div id=":webim-window" class="webim-window ui-widget">                                            <div class="webim-window-tab-wrap">                                            <div id=":tab" class="webim-window-tab ui-state-default">                                            <div class="webim-window-tab-inner">                                                    <div id=":tabTip" class="webim-window-tab-tip">                                                            <strong id=":tabTipC"><%=tooltip%></strong>                                                    </div>                                                    <a id=":tabClose" title="<%=close%>" class="webim-window-close" href="#close"><em class="ui-icon ui-icon-close"><%=close%></em></a>                                                    <div id=":tabCount" class="webim-window-tab-count">                                                            0                                                    </div>                                                    <em id=":tabIcon" class="webim-icon webim-icon-comments"></em>                                                    <h4 id=":tabTitle"><%=title%></h4>                                            </div>                                            </div>                                            </div>                                            <div><div id=":window" class="webim-window-window">\t\t\t\t\t\t<iframe id=":bgiframe" class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe>                                                    <div id=":header" class="webim-window-header ui-widget-header ui-corner-top">                                                            <span id=":actions" class="webim-window-actions">                                                                    <a id=":minimize" title="<%=minimize%>" class="webim-window-minimize" href="#minimize"><em class="ui-icon ui-icon-minus"><%=minimize%></em></a>                                                                    <a id=":maximize" title="<%=maximize%>" class="webim-window-maximize" href="#maximize"><em class="ui-icon ui-icon-plus"><%=maximize%></em></a>                                                                    <a id=":close" title="<%=close%>" class="webim-window-close" href="#close"><em class="ui-icon ui-icon-close"><%=close%></em></a>                                                            </span>                                                            <h4 id=":headerTitle"><%=title%></h4>                                                            <div id=":subHeader" class="webim-window-subheader"></div>                                                    </div>                                                    <div id=":content" class="webim-window-content ui-widget-content">                                                    </div>                                            </div>                                            </div>                                            </div>'},
{html:function(a){J(this.$.content,a)},subHeader:function(a){J(this.$.subHeader,a)},_init:function(a,b){b=this.options;var c=this.$;a=this.element;a.window=this;b.tabWidth&&(c.tab.style.width=b.tabWidth+"px");b.subHeader&&this.subHeader(b.subHeader);this.title(b.title,b.icon);!b.minimizable&&A(c.minimize);!b.maximizable&&A(c.maximize);if(!b.closeable){A(c.tabClose);A(c.close)}b.isMinimize?this.minimize():this.restore();b.onlyIcon?A(c.tabTitle):oa(c.tabTip);b.count&&this.notifyUser("information",b.count);
ia(this)},notifyUser:function(a,b){var c=this.$;if(a=="information")if(this.isMinimize())if(ja(c.tabCount,b)){D(c.tab,"ui-state-highlight");K(c.tab,"ui-state-default")}},_count:function(){return ja(this.$.tabCount)},title:function(a,b){var c=this.$,d=c.tabIcon;if(b)if(Ea(b)){d.className="webim-icon";d.style.backgroundImage="url("+b+")"}else d.className="webim-icon webim-icon-"+b;c.tabTipC.innerHTML=a;d=this.options.titleVisibleLength;if(a){for(var f=0,g=[],j=a.split(""),m=j.length,o=0;o<m;o++)if(f>=
d||f<0)break;else{if(j[o].charCodeAt(0)>255)f+=2;else f++;g.push(j[o])}d=g.join("")}else d=a;(c.tabTitle.innerHTML=d)&&a&&d.length<a.length&&c.tabTitle.setAttribute("title",a);c.headerTitle.innerHTML=a},_changeState:function(a){ka(this.element,"webim-window-normal webim-window-maximize webim-window-minimize","webim-window-"+(a=="restore"?"normal":a));this.trigger("displayStateChange",[a])},active:function(){return ma(this.element,"webim-window-active")},activate:function(){if(!this.active()){D(this.element,
"webim-window-active");this.trigger("activate")}},deactivate:function(){if(this.active()){K(this.element,"webim-window-active");this.options.sticky||this.minimize();this.trigger("deactivate")}},_setVisibile:function(){var a=this.$;ka(a.tab,"ui-state-default ui-state-highlight","ui-state-active");this.activate();ja(a.tabCount,0)},maximize:function(){if(!this.isMaximize()){this._setVisibile();this._changeState("maximize")}},restore:function(){if(!ma(this.element,"webim-window-normal")){this._setVisibile();
this._changeState("restore")}},minimize:function(){if(!this.isMinimize()){ka(this.$.tab,"ui-state-active","ui-state-default");this.deactivate();this._changeState("minimize")}},tabClose:function(){this.close()},close:function(){this.trigger("close");oa(this.element)},_initEvents:function(){var a=this,b=a.$,c=b.tab,d=function(f){na(f);I(f)};z(c,"click",function(f){a.isMinimize()?a.restore():a.minimize();d(f)});z(c,"mouseover",function(){D(this,"ui-state-hover");K(this,"ui-state-default")});z(c,"mouseout",
function(){K(this,"ui-state-hover");this.className.indexOf("ui-state-")==-1&&D(this,"ui-state-default")});z(c,"mousedown",d);W(c);H(sa(b.actions.firstChild),function(f,g){ua(g,"ui-state-hover")});H(["minimize","maximize","close","tabClose"],function(f,g){z(b[g],"click",function(j){this.disabled||a[g]();d(j)});z(b[g],"mousedown",d)})},height:function(){return this.$.content.offsetHeight},_fitUI:function(){},isMaximize:function(){return ma(this.element,"webim-window-maximize")},isMinimize:function(){return ma(this.element,
"webim-window-minimize")}});var ia=function(){var a=false,b=function(){a&&a.deactivate();a=false;return true},c=function(){this&&this!=a&&b()&&(a=this)},d=function(){this&&a==this&&(a=false)};z(B,"mousedown",function(f){f=za(f);for(var g;f;)if(f.id==":webim-window"){g=f;break}else f=f.parentNode;if(g)(f=g.window)&&f.activate();else b()});return function(f){if(f.active()){b();a=f}f.bind("activate",c);f.bind("deactivate",d)}}();ca("layout",function(a){function b(){if(f)return r.updateAllChat();f=true;
var s=m.get("tabs"),w=m.get("tabIds"),C=m.get("p"),R=m.get("a");w&&w.length&&s&&H(s,function(U,ba){var Z=U.slice(2),da=U.slice(0,1);r.addChat(da,Z,{},{isMinimize:true});r.chat(U).window.notifyUser("information",ba.n)});C&&(r.prevCount=C)&&r._fitUI();R&&r.focusChat(R)}function c(){var s={};H(r.tabs,function(w,C){s[w]={n:C._count()}});m.set({tabs:s,tabIds:r.tabIds,p:r.prevCount,a:r.activeTabId})}a=a||{};var d=this.im,f=false,g=d.buddy,j=d.history,m=d.status,o=d.setting,q=d.room,r=this.layout=new u.layout(null,
E({chatAutoPop:d.setting.get("msg_auto_pop")},a,{ui:this}));d.setting.get("minimize_layout")?r.collapse():r.expand();d.bind("beforeOnline",function(){r.changeState("ready")}).bind("online",function(s,w){r.changeState("active");r.options.user=w.user;b()}).bind("offline",function(s,w){w=="offline"&&r.removeAllChat();r.updateAllChat();r.changeState("stop")});o.bind("update",function(s,w,C){if("msg_auto_pop"==w)r.options.chatAutoPop=C;else if("minimize_layout"==w)C?r.collapse():r.expand()});g.bind("online",
function(s,w){r.updateChat("buddy",w)}).bind("offline",function(s,w){r.updateChat("buddy",w)}).bind("update",function(s,w){r.updateChat("buddy",w)});r.bind("collapse",function(){o.set("minimize_layout",true)});r.bind("expand",function(){o.set("minimize_layout",false)});r.bind("displayUpdate",function(){c()});(function(){q.bind("addMember",function(s,w,C){(s=r.chat("room",w))&&s.addMember(C.id,C.nick,C.id==d.data.user.id)}).bind("removeMember",function(s,w,C){(s=r.chat("room",w))&&s.removeMember(C.id,
C.nick)})})();d.bind("message",function(s,w){for(var C=false,R=w.length,U,ba=d.data.user.id,Z,da,Da=0;Da<R;Da++){U=w[Da];Z=U.id;type=U.type;(da=r.chat(type,Z))&&da.status("");if(!da){U.type==="chat"?r.addChat(type,Z,null,null,U.nick):r.addChat(type,Z);da=r.chat(type,Z)}da&&o.get("msg_auto_pop")&&!r.activeTabId&&r.focusChat(Z);da.window.notifyUser("information","+1");Z=da.window.pos;Z==-1&&r.setNextMsgNum("+1");Z==1&&r.setPrevMsgNum("+1");if(U.from!=ba)C=true}if(C){pa.play("msg");wa(t("new message"),
5)}});d.bind("status",function(s,w){H(w,function(C,R){var U=d.data.user.id,ba=R.from;if(!(U!=R.to&&U!=R.from))(U=r.chat("buddy",ba))&&U.status(R.show)})});(function(){j.bind("chat",function(s,w,C){(s=r.chat("chat",w))&&s.history.add(C)});j.bind("grpchat",function(s,w,C){(s=r.chat("grpchat",w))&&s.history.add(C)});j.bind("clear",function(s,w,C){(s=r.chat(w,C))&&s.history.clear()})})();return r});Q("layout",{template:'<div id="webim" class="webim webim-state-ready">\t<div class="webim-preload ui-helper-hidden-accessible">\t<div id="webim-flashlib-c">\t</div>\t</div>\t<div id=":layout" class="webim-layout"><iframe class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe><div class="webim-layout-bg ui-state-default ui-toolbar"></div><div class="webim-ui ui-helper-clearfix">\t<div id=":shortcut" class="webim-shortcut">\t</div>\t<div class="webim-layout-r">\t<div id=":panels" class="webim-panels">\t<div class="webim-window-tab-wrap ui-widget webim-panels-next-wrap">\t<div id=":next" class="webim-window-tab webim-panels-next ui-state-default">\t<div id=":nextMsgCount" class="webim-window-tab-count">\t0\t</div>\t<em class="ui-icon ui-icon-triangle-1-w"></em>\t<span id=":nextCount">0</span>\t</div>\t</div>\t<div id=":tabsWrap" class="webim-panels-tab-wrap">\t<div id=":tabs" class="webim-panels-tab">\t</div>\t</div>\t<div class="webim-window-tab-wrap ui-widget webim-panels-prev-wrap">\t<div id=":prev" class="webim-window-tab webim-panels-prev ui-state-default">\t<div id=":prevMsgCount" class="webim-window-tab-count">\t0\t</div>\t<span id=":prevCount">0</span>\t<em class="ui-icon ui-icon-triangle-1-e"></em>\t</div>\t</div>\t<div class="webim-window-tab-wrap webim-collapse-wrap ui-widget">\t<div id=":collapse" class="webim-window-tab webim-collapse ui-state-default" title="<%=collapse%>">\t<em class="ui-icon ui-icon-circle-arrow-e"></em>\t</div>\t</div>\t<div class="webim-window-tab-wrap webim-expand-wrap ui-widget">\t<div id=":expand" class="webim-window-tab webim-expand ui-state-default" title="<%=expand%>">\t<em class="ui-icon ui-icon-circle-arrow-w"></em>\t</div>\t</div>\t</div>\t<div id=":widgets" class="webim-widgets">\t</div>\t</div>\t</div></div>\t</div>',
shortcutLength:5,chatAutoPop:true,tpl_shortcut:'<div class="webim-window-tab-wrap ui-widget webim-shortcut-item"><a class="webim-window-tab" href="<%=link%>" target="<%=target%>">\t<div class="webim-window-tab-tip">\t<strong><%=title%></strong>\t</div>\t<em class="webim-icon" style="background-image:url(<%=icon%>)"></em>\t</a>\t</div>',chatApp:"chat"},{_init:function(a,b){b=this.options;E(this,{window:y,widgets:{},panels:{},tabWidth:136,maxVisibleTabs:null,animationTime:210,activeTabId:null,tabs:{},
tabIds:[],nextCount:0,prevCount:0});b.unscalable&&D(this.$.layout,"webim-layout-unscalable");b.isMinimize&&this.collapse()},changeState:function(a){this.element.className="webim webim-state-"+a},_ready:false,buildUI:function(){var a=this.$;this.maxVisibleTabs=parseInt(((B.compatMode==="CSS1Compat"&&B.documentElement.clientWidth||B.body.clientWidth)-45-a.shortcut.offsetWidth-a.widgets.offsetWidth-70)/this.tabWidth);this._fitUI();this.options.disableResize||this._autoResizeWindow();this._ready=true},
_autoResizeWindow:function(){var a=this.$.widgets.offsetWidth;for(var b in this.widgets){var c=this.widgets[b]&&this.widgets[b].window;if(c=c&&c.$&&c.$.window)c.style.width=a+"px"}},_updatePrevCount:function(a){var b=this.tabIds,c=this.maxVisibleTabs,d=b.length,f=this.prevCount;if(!(d<=c)){if(a){for(var g=0,j=0;j<d;j++)if(b[j]==a){g=j;break}if(g<=f)f=g;else if(g>=f+c)f=g-c+1}else f=d-c;this.prevCount=f}},_setVisibleTabs:function(a){for(var b=this.prevCount,c=b+this.maxVisibleTabs,d=this.tabs,f=this.tabIds,
g=f.length,j=0,m=0,o=0;o<g;o++){var q=d[f[o]];if(o<b||o>=c)if(a)O(q.element);else{this.activeTabId==f[o]&&q.minimize();var r=q._count();if(o<b){m+=r;q.pos=1}else{j+=r;q.pos=-1}A(q.element)}else{q.pos=0;O(q.element)}}if(!a){this.setNextMsgNum(j);this.setPrevMsgNum(m)}},setNextMsgNum:function(a){ja(this.$.nextMsgCount,a)},setPrevMsgNum:function(a){ja(this.$.prevMsgCount,a)},slideing:false,_slide:function(a){var b=this,c=b.prevCount,d=b.nextCount;if(d>0&&a==-1||c>0&&a==1){b.slideing=true;if(d==1&&a==
-1||c==1&&a==1)b.slideing=false;b._slideSetup(false);b._setVisibleTabs(true);if(a==-1){b.nextCount--;b.prevCount++}else if(a==1){b.nextCount++;b.prevCount--}var f=b.$.tabs,g=parseFloat(f.style.left);c=-1*b.tabWidth*b.nextCount;var j=parseInt(500/13),m=1,o=(c-g)/j,q=setInterval(function(){f.style.left=g+o*m+"px";if(m==j){if(b.slideing)b._slide(a);else{b._fitUI();b._slideReset()}clearInterval(q)}else m++},13)}},_slideUp:function(){this.slideing=false},_slideSetup:function(a){var b=this.$,c=b.tabsWrap;
b=b.tabs;if(!this._tabsWidth)this._tabsWidth=b.clientWidth;if(a)this._tabsWidth=null;c.style.position=a?"":"relative";c.style.overflow=a?"visible":"hidden";c.style.width=a?"":this._tabsWidth+"px";b.style.width=a?"":this.tabWidth*this.tabIds.length+"px";b.style.position=a?"":"relative"},_slideReset:function(){this._slideSetup(true)},_updateCount:function(){var a=this.maxVisibleTabs,b=this.tabIds.length,c=this.prevCount,d=this.nextCount;if(b<=a)c=d=0;else{d=b-a-c;d=d<0?0:d;c=b-a-d}this.prevCount=c;
this.nextCount=d},_updateCountUI:function(){var a=this.$,b=this.prevCount,c=this.nextCount;c<=0?D(a.next,"ui-state-disabled"):K(a.next,"ui-state-disabled");b<=0?D(a.prev,"ui-state-disabled"):K(a.prev,"ui-state-disabled");if(b>0||c>0){a.next.style.display="block";a.prev.style.display="block"}else{A(a.next);A(a.prev)}a.nextCount.innerHTML=c.toString();a.prevCount.innerHTML=b.toString()},_initEvents:function(){var a=this,b=a.$,c=false;z(a.window,"resize",function(){if(c){c=true;a.buildUI()}});z(b.next,
"mousedown",function(){a._slide(-1)});z(b.next,"mouseup",function(){a._slideUp()});W(b.next);z(b.prev,"mousedown",function(){a._slide(1)});z(b.prev,"mouseup",function(){a._slideUp()});W(b.prev);z(b.expand,"click",function(){if(!a.isMinimize())return false;a.expand();a.trigger("expand");return false});z(b.collapse,"click",function(){if(a.isMinimize())return false;a.collapse();a.trigger("collapse");return false});ua(b.collapse,"ui-state-hover","ui-state-default");ua(b.expand,"ui-state-hover","ui-state-default")},
isMinimize:function(){return ma(this.$.layout,"webim-layout-minimize")},collapse:function(){this.isMinimize()||D(this.$.layout,"webim-layout-minimize")},expand:function(){this.isMinimize()&&K(this.$.layout,"webim-layout-minimize")},_displayUpdate:function(){this._ready&&this.trigger("displayUpdate")},_fitUI:function(){this._updateCount();this.$.tabs.style.left=-1*this.tabWidth*this.nextCount+"px";this._updateCountUI();this._setVisibleTabs();this._displayUpdate()},_stickyWin:null,_widgetStateChange:function(a,
b){b!="minimize"&&H(this.widgets,function(c,d){d.window!=a&&d.window.minimize()});this._displayUpdate()},widget:function(a){return this.widgets[a]},addWidget:function(a,b,c,d){var f=this;b=E(b,{closeable:false,subHeader:a.header});var g=a.element;b=new u.window(null,b);b.html(g);f.$[d?d:"widgets"].insertBefore(b.element,c&&f.widgets[c]?f.widgets[c].window.element:null);a.window=b;b.bind("displayStateChange",function(j,m){f._widgetStateChange(this,m)});f.widgets[a.name]=a},focusChat:function(a,b){b=
V(a,b);var c=this.tabs[b],d=this.panels[b];c&&c.isMinimize()&&c.restore();d&&d.focus()},chat:function(a,b){return this.panels[V(a,b)]},updateChat:function(a,b){b=aa(b);for(var c,d=b.length,f,g=0;g<d;g++){c=b[g];(f=this.panels[V(a,c.id)])&&f.update(c)}},updateAllChat:function(){H(this.panels,function(a,b){b.update()})},_onChatClose:function(a){this.tabIds=S(this.tabIds,function(b){return b!=a});delete this.tabs[a];delete this.panels[a];this._changeActive(a,true);this._fitUI()},_onChatChange:function(a,
b){if(b=="minimize"){this._changeActive(a,true);this._displayUpdate()}else{this._changeActive(a);this._fitUI()}},_changeActive:function(a,b){var c=this.activeTabId;if(b)c==a&&(this.activeTabId=null);else{c&&c!=a&&this.tabs[c].minimize();this.activeTabId=a;this._updatePrevCount(a)}},addChat:function(a,b,c,d,f){a=ha(a);var g=this;if(!g.chat(a,b)){var j=g.panels,m=V(a,b);d=g.tabs[m]=(new u.window(null,E({isMinimize:g.activeTabId||!g.options.chatAutoPop,tabWidth:g.tabWidth-2,titleVisibleLength:9},d))).bind("close",
function(){g._onChatClose(m)}).bind("displayStateChange",function(o,q){g._onChatChange(m,q)});a=g.options.ui.addApp(g.options.chatApp,E({id:b,type:a,nick:f,window:d},c));j[m]=a;g.tabIds.push(m);g.$.tabs.insertBefore(d.element,g.$.tabs.firstChild);!d.isMinimize()&&g._changeActive(m);g._fitUI()}},removeChat:function(a,b){var c=this.tabs[V(a,b)];c&&c.close()},removeAllChat:function(){H(this.tabs,function(a,b){b.close()})},addShortcut:function(a){var b=this;if(G(a))H(a,function(f,g){b.addShortcut(g)});
else if(P(a)){var c=b.$.shortcut,d=b.options.tpl_shortcut;if(!(c.childNodes.length>b.options.shortcutLength+1)){d=N(T(d,{title:t(a.title),icon:a.icon,link:a.link,target:a.isExtlink?"_blank":""}));ua(d.firstChild,"ui-state-hover");c.appendChild(d)}}}});Q("history",{user:{},info:{},template:'<div class="webim-history">                        <div id=":content" class="webim-history-content">                 </div></div>'},{_init:function(){ea.call(this,"init",[null,this.ui()])},clear:function(){this.$.content.innerHTML=
"";this.trigger("clear")},add:function(a){a=aa(a);var b=a.length,c=[];if(b){for(var d=0;d<b;d++)c.push(this._renderMsg(a[d]));this.$.content.appendChild(N("<div>"+c.join("")+"</div>"));this.trigger("update")}},notice:function(a){this.$.content.appendChild(N("<div class='ui-corner-all webim-history-notice ui-state-default ui-state-error'>"+a+"</div>"));this.trigger("update")},_renderMsg:function(a){a=E({},a);ea.call(this,"render",[null,this.ui({msg:a})]);var b=a.from,c=a.to,d=a.timestamp,f=a.body,
g=true,j=this._lastLogItem,m=[],o;o=a.nick;if(j&&j.to==c&&j.from==b&&d-j.timestamp<6E4)g=false;if(g){this._lastLogItem=a;a=new h(d);m.push('<h4><span class="webim-gray">');m.push(a.getDay(true));m.push(" ");m.push(a.getTime());m.push("</span>");m.push(o);m.push('</h4><hr class="webim-line ui-state-default" />')}m.push("<p>");m.push(f);m.push("</p>");return m.join("")},_renderDateBreak:function(a){var b=this._lastLogItem,c=new Date,d=new Date,f=[];c.setTime(a);b&&d.setTime(b.timestamp);if(!b||c.getDate()!=
d.getDate()||c.getMonth()!=d.getMonth()){f.push("<h5>");f.push((new h(a)).getDay(true));f.push("</h5>")}return f.join("")},ui:function(a){return E({element:this.element,$:this.$},a)},plugins:{}});var va=function(){function a(d,f,g,j,m,o,q,r){if(f)return'<a href="'+(f=="www."?"http://"+d:d)+'"'+c+">"+d+"</a>";if(j)return'<a class="webim-img" href="'+o+'"'+c+'><img src="'+(r||o)+'" alt="'+(m||o)+'"/></a>';return'<a class="webim-file" href="'+o+'"'+c+">"+(m||o)+"</a>"}function b(d,f){c+=" "+d+'="'+f+
'"'}var c;return function(d,f){c="";f&&P(f)&&H(f,b);return d.replace(/(https?:\/\/|www\.)([^\s<]+)|(\!?)\[([^\]]*)\]\(([^\)]+)\)(\(([^\)]+)\))?/ig,a)}}();u.history.defaults.parseMsg=true;ea.add("history","parseMsg",{render:function(a,b){var c=b.msg.body;c=ra(c);c=va(c,{target:"_blank"});b.msg.body=c}});u.history.defaults.emot=true;ea.add("history","emot",{render:function(a,b){b.msg.body=u.emot.parse(b.msg.body)}});Q("emot",{template:'<div class="webim-emot ui-widget-content"><%=emots%></div>'},{_init:function(){var a=
this,b=a.element;H(b.firstChild.childNodes,function(c,d){z(d,"click",function(){K(b,"webim-emot-show");a.trigger("select",this.firstChild.getAttribute("rel"))})})},template:function(){var a=this.emots=webim.ui.emot.emots,b=[];b.push('<ul class="ui-helper-clearfix">');H(a,function(c,d){var f=d.src,g=d.t?d.t:d.q[0];b.push('<li><img src="');b.push(f);b.push('" title="');b.push(g);b.push('" alt="');b.push(d.q[0]);b.push('" rel="');b.push(d.q[0]);b.push('" /></li>')});b.push("</ul>");return T(this.options.template,
{emots:b.join("")})},toggle:function(){fa(this.element,"webim-emot-show")}});E(u.emot,{emots:[{t:"smile",src:"smile.png",q:[":)"]},{t:"smile_big",src:"smile-big.png",q:[":d",":-d",":D",":-D"]},{t:"sad",src:"sad.png",q:[":(",":-("]},{t:"wink",src:"wink.png",q:[";)",";-)"]},{t:"tongue",src:"tongue.png",q:[":p",":-p",":P",":-P"]},{t:"shock",src:"shock.png",q:["=-O","=-o"]},{t:"kiss",src:"kiss.png",q:[":-*"]},{t:"glasses_cool",src:"glasses-cool.png",q:["8-)"]},{t:"embarrassed",src:"embarrassed.png",q:[":-["]},
{t:"crying",src:"crying.png",q:[":'("]},{t:"thinking",src:"thinking.png",q:[":-/",":-\\"]},{t:"angel",src:"angel.png",q:["O:-)","o:-)"]},{t:"shut_mouth",src:"shut-mouth.png",q:[":-X",":-x"]},{t:"moneymouth",src:"moneymouth.png",q:[":-$"]},{t:"foot_in_mouth",src:"foot-in-mouth.png",q:[":-!"]},{t:"shout",src:"shout.png",q:[">:o",">:O"]}],init:function(a){var b=webim.ui.emot,c=b._q={};a=E({dir:"webim/static/emot/default"},a);if(a.emots)b.emots=a.emots;var d=a.dir+"/";H(b.emots,function(f,g){if(g&&g.src)g.src=
d+g.src;g&&g.q&&H(g.q,function(j,m){c[m]=f})})},parse:function(a){var b=webim.ui.emot._q,c=webim.ui.emot.emots;b&&H(b,function(d,f){var g=c[f],j=g.src,m=g.t?g.t:g.q[0],o=[];o.push('<img src="');o.push(j);o.push('" title="');o.push(m);o.push('" alt="');o.push(g.q[0]);o.push('" />');d=ra(d);d=d.replace(RegExp("(\\"+".$^*\\[]()|+?{}:<>".split("").join("|\\")+")","g"),"\\$1");a=a.replace(RegExp(d,"g"),o.join(""))});return a}});Q("upload",{template:'<div class="webim-upload ui-widget-content"><form class="ui-helper-clearfix" id=":form" method="POST" enctype="multipart/form-data" encoding="multipart/form-data"><input id=":input" type="file" name="files" /><input class="ui-state-default ui-corner-all webim-upload-submit" type="submit" value="<%=upload%>" /></form></div>'},
{_init:function(){var a=this;a.$.form.setAttribute("action",ga("upload"));v(a.$.form,function(b){if(b=b&&b[0])if(!b.url||b.error)alert(b.error||"Upload error");else{for(var c="",d=["image/jpeg","image/jpg","image/gif","image/png"],f=0;f<d.length;f++)if(d[f]==b.type){c="!";break}c+="["+(b.name||"").replace(/\[|\]/ig,"")+"]("+b.url+")";if(b.thumbnailUrl)c+="("+b.thumbnailUrl+")";try{a.$.input.value=""}catch(g){}a.toggle();a.trigger("upload",c)}else alert("Upload error")})},toggle:function(){fa(this.element,
"webim-upload-show")}});ca("chat",function(a){a=a||{};var b=this,c=b.im,d=c.buddy,f=c.room,g=c.history,j=a.id,m=a.type;if(m=="room"){var o=g.get("grpchat",j);o||g.load("grpchat",j);var q=c.room.get(j)||{id:j,nick:a.nick||j};q.presence="online";a=E({emot:true,clearHistory:false,member:true,block:true,downloadHistory:false},b.options.roomChatOptions,{info:q,user:c.data.user,history:o,type:m},a);var r=new u.chat(null,a);r.bind("sendMessage",function(s,w){c.sendMessage(w,function(C){C&&C.message&&r.history.notice(C.message)});
g.set(w)}).bind("downloadHistory",function(s,w){g.download("grpchat",w.id)}).bind("select",function(s,w){w.presence="online";d.presence(w);b.layout.addChat("buddy",w.id,w.nick);b.layout.focusChat("buddy",w.id)}).bind("block",function(s,w){f.block(w.id)}).bind("unblock",function(s,w){f.unblock(w.id)}).bind("destroy",function(){r.options.info.blocked&&f.leave(j)});setTimeout(function(){r.options.info.blocked?f.join(j):f.initMember(j)},500);G(q.members)&&H(q.members,function(s,w){r.addMember(w.id,w.nick,
w.id==c.data.user.id)})}else{(o=g.get("chat",j))||g.load("chat",j);q=c.buddy.get(j)||{id:j,nick:a.nick||j};a=E({emot:true,clearHistory:true},b.options.buddyChatOptions,{info:q,user:c.data.user,history:o,block:false,member:false,msgType:"chat"},a);r=new u.chat(null,a);c.buddy.get(j)||c.buddy.update(j);r.bind("sendMessage",function(s,w){c.sendMessage(w,function(C){C&&C.message&&r.history.notice(C.message)});g.set(w)}).bind("sendStatus",function(s,w){c.sendStatus(w)}).bind("clearHistory",function(s,
w){g.clear("chat",w.id)}).bind("downloadHistory",function(s,w){g.download("chat",w.id)})}return r});Q("chat",{tpl_header:'<div><div id=":user" class="webim-user"> \t<a id=":userPic" class="webim-user-pic ui-corner-all ui-state-active" href="#id"><img width="50" height="50" src="" defaultsrc="" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" class="ui-corner-all"></a> \t<span id=":userStatus" title="" class="webim-user-status">&nbsp;</span> \t</div></div>',template:'<div id=":container" class="webim-chat webim-box webim-flex"> \t<div class="webim-chat-notice-wrap1"><div class="webim-chat-notice-wrap"><div id=":notice" class="webim-chat-notice ui-state-highlight"></div></div> </div>\t<div id=":content" class="webim-chat-content webim-flex webim-box-h"> \t<div id=":sidebar" class="webim-chat-sidebar webim-box"></div><div class="webim-flex webim-box"><div id=":main" class="webim-chat-main webim-flex"><div id=":status" class="webim-chat-status webim-gray"></div></div></div> \t</div> \t<div id=":actions" class="webim-chat-actions"> \t<div id=":toolContent" class="webim-chat-tool-content"></div>\t<div id=":tools" class="webim-chat-tools ui-helper-clearfix ui-state-default"></div>\t<table class="webim-chat-t" cellSpacing="0"> \t<tr> \t<td style="vertical-align:top;"> \t<em class="webim-icon webim-icon-chat-edit"></em>\t</td> \t<td style="vertical-align:top;width:100%;"> \t<div class="webim-chat-input-wrap">\t<textarea id=":input" class="webim-chat-input webim-gray ui-widget-content"><%=input notice%></textarea> \t</div> \t</td> \t</tr> \t</table> \t</div> \t</div>'},
{_init:function(){var a=this,b=a.element,c=a.options,d=c.window,f=a.history=new u.history(null,{user:c.user,info:c.info});D(b,"webim-chat-"+c.type);a.$.main.insertBefore(f.element,a.$.main.firstChild);a.header=N(T(c.tpl_header));E(a.$,L(a.header));a._initEvents();d&&a.setWindow(d);c.simple&&A(a.header);a.update(c.info);f.add(c.history);ea.call(a,"init",[null,a.ui()]);setTimeout(function(){a._adjustContent()},0)},setWindow:function(a,b){this.window=a;a.subHeader(this.header);!b&&a.html(this.element);
a.title(this.options.info.nick);this._bindWindow()},update:function(a){if(a){this.options.info=a;this.history.options.info=a;this._updateInfo(a)}a=this.options.info.presence=="online";if(this.options.user.presence=="online")a?this.notice(""):this.notice(t("buddy offline notice",{name:this.options.info.nick}));else this.notice(t("user offline notice"));ea.call(this,"update",[null,this.ui()])},focus:function(){var a=this.$.input;y.setTimeout(function(){try{a.focus()}catch(b){}},0)},_noticeTime:null,
_noticeTxt:"",notice:function(a,b){var c=this,d=c.$.notice,f=c._noticeTime;f&&clearTimeout(f);if(a)if(b){d.innerHTML=a;O(d);setTimeout(function(){if(c._noticeTxt)d.innerHTML=c._noticeTxt;else A(d,500)},b)}else{c._noticeTxt=a;d.innerHTML=a;O(d)}else{c._noticeTxt=null;A(d)}},_adjustContent:function(){var a=this.$.main;if(a.scrollTop!=a.scrollHeight)a.scrollTop=a.scrollHeight},_fitUI:function(){this._adjustContent()},_bindWindow:function(){var a=this;a.window.bind("displayStateChange",function(b,c){if(c!=
"minimize"){y.setTimeout(function(){a.$.input.focus()},0);a._adjustContent()}}).bind("close",function(){a.destroy()})},_inputAutoHeight:function(){var a=this.$.input,b=a[0].scrollTop;if(b>0){var c=a.height();c>32&&c<100&&a.height(c+b)}},sendMessage:function(a){var b=this.options,c=b.info;a={type:b.type=="room"?"grpchat":"chat",to:c.id,from:b.user.id,nick:b.user.nick,to_nick:c.nick,offline:c.presence!="online"?"true":"false",timestamp:(new Date).getTime()-h.timeSkew,body:a};ea.call(this,"send",[null,
this.ui({msg:a})]);this.trigger("sendMessage",[a])},_inputkeypress:function(a){if(a.keyCode==13)if(a.ctrlKey){this.insert("\n",true);return true}else{var b=za(a),c=b.value;if($(c).length){this.sendMessage(c);b.value="";I(a)}}else this._typing()},_onFocusInput:function(a){var b=this;za(a);(y.getSelection?y.getSelection().toString():B.selection?B.selection.createRange().text:"")||y.setTimeout(function(){b.$.input.focus()},0)},_initEvents:function(){var a=this,b=a.$,c=t("input notice"),d=b.input;a.history.bind("update",
function(){a._adjustContent()}).bind("clear",function(){a.notice(t("clear history notice"),3E3)});z(d,"keyup",function(){xa.call(this)});z(d,"click",xa);z(d,"select",xa);z(d,"focus",function(){K(this,"webim-gray");if(this.value==c)this.value=""});z(d,"blur",function(){if(this.value==""){D(this,"webim-gray");this.value=c}});z(d,"keypress",function(f){a._inputkeypress(f)});z(b.main,"click",function(f){a._onFocusInput(f)})},_updateInfo:function(a){var b=this.$;b.userPic.setAttribute("href",a.url);b.userPic.setAttribute("target",
a.target||this.options.target||"");b.userPic.firstChild.setAttribute("defaultsrc",a.default_pic_url?a.default_pic_url:"");setTimeout(function(){if(a.pic_url||a.default_pic_url)try{b.userPic.firstChild.setAttribute("src",a.pic_url||a.default_pic_url)}catch(c){}},100);b.userStatus.innerHTML=Aa(a.status)||"&nbsp";this.window&&this.window.title(a.nick,a.show)},insert:function(a,b){var c=this.$.input;c.focus();if(b){a||(a="");if(c.setSelectionRange){var d=c.value,f=c.selectionStart,g=c.selectionEnd,j=
d.substring(0,f);d=d.substring(g);g=a.length;c.value=j+a+d;c.setSelectionRange(f+g,f+g)}else if(B.selection)if(f=c.caretPos){f.text=a;f.collapse();f.select()}else c.value+=a;else c.value+=a}else c.value=a},_statusText:"",sendStatus:function(a){if(!(!a||a==this._statusText||this.options.info.presence=="offline")){this._statusText=a;this.trigger("sendStatus",[{to:this.options.info.id,show:a}])}},_checkST:false,_typing:function(){var a=this;a.sendStatus("typing");a._checkST&&clearTimeout(a._checkST);
a._checkST=y.setTimeout(function(){a.sendStatus("clear")},6E3)},_setST:null,status:function(a){a=a||"clear";var b=this.$.status,c=this.options.info.nick,d="";d=a=="clear"?"":c+t(a);b.innerHTML=d;this._adjustContent();this._setST&&clearTimeout(this._setST);if(d!="")this._setST=y.setTimeout(function(){b.innerHTML=""},1E4)},destroy:function(){this.trigger("destroy")},ui:function(a){return E({self:this,$:this.$,history:this.history},a)},plugins:{}});u.chat.defaults.emot=true;ea.add("chat","emot",{init:function(a,
b){var c=b.self,d=c.emot=new u.emot;d.bind("select",function(g,j){c.focus();c.insert(j,true)});var f=N(T('<a href="#chat-emot" title="<%=emot%>"><em class="webim-icon webim-icon-emot"></em></a>'));z(f,"click",function(g){c.upload&&K(c.upload.element,"webim-upload-show");I(g);d.toggle()});b.$.toolContent.appendChild(d.element);b.$.tools.appendChild(f)},send:function(){}});u.chat.defaults.upload=false;ea.add("chat","upload",{init:function(a,b){var c=b.self,d=c.upload=new u.upload;d.bind("upload",function(g,
j){c.sendMessage(j)});var f=N(T('<a href="#chat-upload" title="<%=upload%>"><em class="webim-icon webim-icon-upload"></em></a>'));z(f,"click",function(g){c.emot&&K(c.emot.element,"webim-emot-show");I(g);d.toggle()});b.$.toolContent.appendChild(d.element);b.$.tools.appendChild(f)},send:function(){}});u.chat.defaults.clearHistory=true;ea.add("chat","clearHistory",{init:function(a,b){var c=b.self,d=N(T('<a href="#chat-clearHistory" title="<%=clear history%>"><em class="webim-icon webim-icon-clear"></em></a>'));
z(d,"click",function(f){I(f);c.trigger("clearHistory",[c.options.info])});b.$.tools.appendChild(d)}});u.chat.defaults.block=true;ea.add("chat","block",{init:function(a,b){var c=b.self,d=c.options.info.blocked,f=c.options.info.nick,g=N('<a href="#chat-block" style="display:'+(d?"none":"")+'" title="'+t("block group",{name:f})+'"><em class="webim-icon webim-icon-unblock"></em></a>'),j=N('<a href="#chat-block" style="display:'+(d?"":"none")+'" title="'+t("unblock group",{name:f})+'"><em class="webim-icon webim-icon-block"></em></a>');
z(g,"click",function(m){I(m);A(g);O(j);c.trigger("block",[c.options.info])});z(j,"click",function(m){I(m);A(j);O(g);c.trigger("unblock",[c.options.info])});b.$.tools.appendChild(g);b.$.tools.appendChild(j)}});u.chat.defaults.member=true;E(u.chat.prototype,{addMember:function(a,b,c){var d=this,f=d.memberLi;if(!f[a]){var g=N('<li><a class="'+(c?"ui-state-disabled":"")+'" href="'+a+'">'+b+"</a></li>");z(g.firstChild,"click",function(j){I(j);c||d.trigger("select",[{id:a,nick:b}])});f[a]=g;d.$.member.appendChild(g);
d.$.memberCount.innerHTML=parseInt(d.$.memberCount.innerHTML)+1}},removeMember:function(a){var b=this.memberLi[a];if(b){this.$.member.removeChild(b);delete this.memberLi[a];this.$.memberCount.innerHTML=parseInt(this.$.memberCount.innerHTML)-1}}});ea.add("chat","member",{init:function(a,b){var c=b.$;b.self.memberLi={};var d=N(T('<div class="webim-box webim-flex  webim-member ui-widget-content ui-corner-left"><iframe id=":bgiframe" class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe><h4><%=room member%>:<span id=":memberCount">0</span></h4><ul id=":ul" class="webim-flex"></ul></div>')),
f=L(d);c.member=f.ul;c.memberCount=f.memberCount;c.sidebar.appendChild(d)}});u.chat.defaults.downloadHistory=true;ea.add("chat","downloadHistory",{init:function(a,b){var c=b.self,d=N(T('<a style="float: right;" href="#chat-downloadHistory" title="<%=download history%>"><em class="webim-icon webim-icon-download"></em></a>'));z(d,"click",function(f){I(f);c.trigger("downloadHistory",[c.options.info])});b.$.tools.appendChild(d)}});ca("setting",function(a){var b=this.im.setting,c=this.layout,d=this.setting=
new u.setting(null,a);c.addWidget(d,{title:t("setting"),icon:"setting",sticky:false,onlyIcon:true,isMinimize:true});b.bind("update",function(f,g,j){typeof j!="object"&&d.check_tag(g,j)});d.bind("change",function(f,g,j){b.set(g,j)})});Q("setting",{template:'<div id="webim-setting" class="webim-setting">\t\t\t<ul id=":ul"><%=tags%></ul>\t\t   </div>',tpl_check:'<li id=":<%=name%>"><input type="checkbox" <%=checked%> id="webim-setting-<%=name%>" name="<%=name%>"/><label for="webim-setting-<%=name%>"><%=label%></label></li>'},
{_init:function(){var a=this.options.copyright;if(a){a=a===true?'<p style="margin: 5px 10px;text-align:right;"><a class="webim-gray" href="http://nextalk.im/" target="_blank">Powered by NextTalk</a></p>':a;this.element.appendChild(N(a))}},template:function(){var a=this,b=[],c=a.options.data;c&&H(c,function(d,f){f&&typeof f!="boolean"||b.push(a._check_tpl(d,f))});return T(a.options.template,{tags:b.join("")})},_initEvents:function(){var a=this,b=a.options.data,c=a.$;b&&H(b,function(d){c[d]&&a._check_event(c[d])})},
_check_tpl:function(a,b){return T(this.options.tpl_check,{label:t(a),name:a,checked:b?'checked="checked"':""})},_check_event:function(a){var b=this;z(a.firstChild,"click",function(){b._change(this.name,this.checked)})},check_tag:function(a,b){var c=this;if(P(a))H(a,function(g,j){c.check_tag(g,j)});else{var d=c.$,f=d[a];if(!(b&&typeof b!="boolean"))if(f)f.firstChild.checked=b;else{f=d[a]=N(c._check_tpl(a,b));c._check_event(f);d.ul.appendChild(f)}}},_change:function(a,b){this.trigger("change",[a,b])},
destroy:function(){}});ca("user",function(a){a=a||{};var b=this.im,c=new u.user;!a.show&&A(c.element);a.container&&a.container.appendChild(c.element);c.bind("online",function(d,f){b.online(f)}).bind("offline",function(){b.offline()}).bind("presence",function(d,f){b.sendPresence(f)});c.update(b.data.user);b.bind("online",function(){O(c.element);c.update(b.data.user)}).bind("offline",function(){c.show("unavailable")});return c});Q("user",{template:'<div>  \t\t<div id=":user" class="webim-user"> \t\t\t<a id=":userPic" class="webim-user-pic ui-corner-all ui-state-active" href="#id"><img width="50" height="50" defaultsrc="" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" class="ui-corner-all"></a> \t\t\t\t<div class="webim-user-show"><h4><a  id=":userShowTrigger" href="#show"><strong id=":userNick"></strong><span id=":userShow"><em class="webim-icon webim-icon-unavailable"><%=unavailable%></em><%=unavailable%></span><em class="ui-icon ui-icon-triangle-1-s"><%=show_status_list%></em></a></h4>\t\t\t\t\t<p id=":userShowList" class="ui-state-active ui-corner-all" style="display: none;">\t\t\t\t\t\t<a href="#available" class="webim-user-show-available"><em class="webim-icon webim-icon-available"><%=available%></em><%=available%></a>\t\t\t\t\t\t<a href="#dnd" class="webim-user-show-dnd"><em class="webim-icon webim-icon-dnd"><%=dnd%></em><%=dnd%></a>\t\t\t\t\t\t<a href="#away" class="webim-user-show-away"><em class="webim-icon webim-icon-away"><%=away%></em><%=away%></a>\t\t\t\t\t\t<a href="#invisible" class="webim-user-show-invisible"><em class="webim-icon webim-icon-invisible"><%=invisible%></em><%=invisible%></a>\t\t\t\t\t\t<a href="#unavailable" class="webim-user-show-unavailable"><em class="webim-icon webim-icon-unavailable"><%=unavailable%></em><%=unavailable%></a>\t\t\t\t\t</p>\t\t\t\t</div> \t\t\t\t\t<span id=":userStatus" title="" class="webim-user-status"></span> \t\t\t\t\t\t</div> \t\t\t\t\t\t\t</div>'},
{_init:function(){},_initEvents:function(){var a=this,b=a.$,c=b.userShowList;z(b.userShowTrigger,"click",function(d){c.style.display=="block"?A(c):O(c);I(d)});H(sa(c.firstChild),function(d,f){z(f,"click",function(g){a._set(this.href.split("#")[1]);A(c);I(g)})})},update:function(a){var b=a.show||"unavailable",c=this.$;this.options.info=a;c.userStatus.innerHTML=Aa(a.status)||"&nbsp;";c.userNick.innerHTML=a.nick||"";c.userPic.setAttribute("href",a.url);c.userPic.firstChild.setAttribute("defaultsrc",
a.default_pic_url?a.default_pic_url:"");setTimeout(function(){if(a.pic_url||a.default_pic_url)c.userPic.firstChild.setAttribute("src",a.pic_url||a.default_pic_url)},100);this.show(b)},show:function(a){var b=t(a);this.$.userShow.innerHTML='<em class="webim-icon webim-icon-'+a+'">'+b+"</em>"+b},_set:function(a){var b=this.options.info;this.show(a);if(b){if(b.show!=a)if(a=="unavailable")this.trigger("offline",[]);else b.show=="unavailable"?this.trigger("online",[{show:a}]):this.trigger("presence",[{show:a,
status:b.status}])}else a!="unavailable"&&this.trigger("online",[{show:a}])},destroy:function(){}});ca("login",function(a){a=a||{};var b=this.im,c=new u.login(null,a);a.container&&a.container.appendChild(c.element);c.bind("login",function(d,f){b.online(f)});b.bind("online",function(){c.hide()}).bind("offline",function(d,f,g){f=="online"&&c.showError(g)});return c});Q("login",{questions:null,notice:"",template:'<div id=":login" class="webim-login"> \t\t\t<div class="webim-login-logo" id=":logo"></div>\t\t\t<div class="webim-login-notice" id=":notice"></div>\t\t\t<div class="ui-state-error webim-login-error ui-corner-all" style="display: none;" id=":error"></div>\t\t\t<form id=":form">\t\t\t\t<p class="ui-helper-clearfix"><label for=":username"><%=username%></label><input name="username" id=":username" type="text" /></p>\t\t\t\t<p class="ui-helper-clearfix"><label for=":password"><%=password%></label><input name="password" id=":password" type="password" /></p>\t\t\t\t<div id=":more">\t\t\t\t<p class="ui-helper-clearfix"><label for=":question"><%=question%></label><select name="question" id=":question" ></select></p>\t\t\t\t<p class="ui-helper-clearfix"><label for=":answer"><%=answer%></label><input name="answer" id=":answer" type="text" /></p>\t\t\t\t</div>\t\t\t\t<p class="ui-helper-clearfix"><input name="submit" id=":submit" class="ui-state-default ui-corner-all webim-login-submit" value="<%=login%>" type="submit" /></p>\t\t\t</form>\t\t</div>'},
{_init:function(){var a=this.options.questions,b=this.$;a&&a.length?H(a,function(c,d){var f=B.createElement("option");f.value=d[0];f.innerHTML=d[1];b.question.appendChild(f)}):A(b.more);b.notice.innerHTML=this.options.notice},_initEvents:function(){var a=this,b=a.$;ua(b.submit,"ui-state-hover");z(b.form,"submit",function(c){I(c);a.trigger("login",[{username:b.username.value,password:b.password.value,question:b.question.value,answer:b.answer.value}])})},hide:function(){A(this.element)},show:function(){O(this.element)},
hideError:function(){A(this.$.error)},showError:function(a){var b=this.$.error;b.innerHTML=t(a);O(b)},destroy:function(){}});ca("buddy",function(a){a=a||{};var b=this,c=b.im,d=c.buddy,f=b.layout,g=new u.buddy(null,E({title:a.title||t("buddy")},a));f.addWidget(g,{className:"webim-buddy-window",title:a.title||t("buddy"),titleVisibleLength:19,sticky:c.setting.get("buddy_sticky"),isMinimize:!c.status.get("b"),icon:"buddy"});g.bind("select",function(r,s){b.layout.addChat("buddy",s.id);b.layout.focusChat("buddy",
s.id)});var j;if(!a.disable_user){j=b.addApp("user",a.userOptions);if(a.is_login){g.window.subHeader(j.element);O(j.element);j=null}}!a.is_login&&!a.disable_login&&b.addApp("login",E({container:g.$.content},a.loginOptions));c.setting.bind("update",function(r,s){if(r=="buddy_sticky")g.window.option.sticky=s});g.window&&g.window.bind("displayStateChange",function(r,s){if(s!="minimize"){d.options.active=true;c.status.set("b",1);d.complete()}else{c.status.set("b",0);d.options.active=false}});var m=function(r){return P(r)?
r.id:r},o=function(r){return r.show!="invisible"&&r.presence=="online"},q=function(r){return r.show=="invisible"};d.bind("online",function(r,s){g.add(S(s,o));g.update(s)});d.bind("offline",function(r,s){if(a.showUnavailable){g.remove(Ba(s,m));g.add(s)}else g.remove(Ba(s,m))});d.bind("update",function(r,s){g.add(S(s,o));g.update(S(s,o));g.remove(Ba(S(s,q),m))});g.offline();c.bind("beforeOnline",function(){g.online()}).bind("online",function(){j&&g.window.subHeader(j.element);g.titleCount()}).bind("offline",
function(){g.offline()});return g});Q("buddy",{template:'<div id="webim-buddy" class="webim-buddy webim-flex webim-box">\t\t<div id=":search" class="webim-buddy-search ui-state-default ui-corner-all"><em class="ui-icon ui-icon-search"></em><input id=":searchInput" type="text" value="" /></div>\t\t\t<div class="webim-buddy-content webim-flex" id=":content">\t\t\t\t<div id=":empty" class="webim-buddy-empty"><%=empty buddy%></div>\t\t\t\t\t<ul id=":ul"></ul>\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>',tpl_group:'<li><h4><em class="ui-icon ui-icon-triangle-1-s"></em><span><%=title%>(<%=count%>)</span></h4><hr class="webim-line ui-state-default" /><ul></ul></li>',
tpl_li:'<li title="" class="webim-buddy-<%=show%>"><a href="<%=url%>" rel="<%=id%>" class="ui-helper-clearfix"><div id=":tabCount" class="webim-window-tab-count">0</div><em class="webim-icon webim-icon-<%=show%>" title="<%=human_show%>"><%=show%></em><img width="25" src="<%=pic_url%>" defaultsrc="<%=default_pic_url%>" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" /><strong><%=nick%></strong><span><%=status%></span></a></li>'},{_init:function(){var a=this.options;
this.groups={};this.li={};this.li_group={};this.size=0;a.disable_group&&D(this.element,"webim-buddy-hidegroup");a.simple&&D(this.element,"webim-buddy-simple")},_initEvents:function(){var a=this,b=a.$,c=b.search,d=b.searchInput,f=t("search buddy");z(c.firstChild,"click",function(){d.focus()});d.value=f;z(d,"focus",function(){D(c,"ui-state-active");if(this.value==f)this.value=""});z(d,"blur",function(){K(c,"ui-state-active");if(this.value=="")this.value=f});z(d,"keyup",function(){var g=this.value;H(a.li,
function(j,m){g&&(m.text||m.innerHTML.replace(/<[^>]*>/g,"")).indexOf(g)==-1?A(m):O(m)})})},titleCount:function(){var a=this.size,b=this.window,c=this.$.empty;b&&b.title(this.options.title+"("+(a?a:"0")+")");a?A(c):O(c);a>8?this.scroll(true):this.scroll(false)},scroll:function(a){fa(this.element,"webim-buddy-scroll",a)},_time:null,_titleBuddyOnline:function(a){var b=this;a||(a="");b._time&&clearTimeout(b._time);b._time=setTimeout(function(){b.titleCount()},5E3)},_title:function(a){var b=this.window;
b&&b.title(this.options.title+"["+t(a)+"]")},notice:function(a,b){switch(a){case "buddyOnline":this._titleBuddyOnline(b);break;default:this._title(a)}},online:function(){var a=this.$;this.notice("connect");A(a.empty)},offline:function(){var a=this.$;this.scroll(false);this.removeAll();A(a.empty);this.notice("offline")},_updateInfo:function(a,b){var c=b.show?b.show:"available";a.className="webim-buddy-"+c;a=a.firstChild;a.setAttribute("href",b.url);a=a.firstChild;a=a.nextSibling;a.className="webim-icon webim-icon-"+
c;a.setAttribute("title",t(c));a=a.nextSibling;a.setAttribute("defaultsrc",b.default_pic_url?b.default_pic_url:"");if(b.pic_url||b.default_pic_url)a.setAttribute("src",b.pic_url||b.default_pic_url);a=a.nextSibling;a.innerHTML=b.nick;a=a.nextSibling;a.innerHTML=Aa(b.status)||"&nbsp;";return a},showCount:function(a,b){var c=this.li;c[a]&&ja(c[a].firstChild.firstChild,b)},_addOne:function(a,b){var c=this,d=c.li,f=a.id,g=c.$.ul;if(!d[f]){c.size++;if(!a.default_pic_url)a.default_pic_url="";a.status=Aa(a.status)||
"&nbsp;";a.show=a.show||"available";a.human_show=t(a.show);a.pic_url=a.pic_url||"";d=d[f]=N(T(c.options.tpl_li,a));z(d.firstChild,"click",function(s){I(s);c.showCount(f,0);c.trigger("select",[a]);this.blur()});var j=c.groups,m=t(a.group||"friend");j=j[m];if(!j){j=N(T(c.options.tpl_group));A(j);if(m==t("stranger"))b=true;if(b){g.appendChild(j);c._lastChild=j}else c._lastChild?g.insertBefore(j,g.lastChild):g.appendChild(j);var o=j.lastChild;g=j.firstChild;var q=g.firstChild,r=c.options.collapse;j={name:m,
el:j,count:0,title:j.firstChild.lastChild,li:o};c.groups[m]=j;if(r===la)A(q);else{if(r){ka(q,"ui-icon-triangle-1-s","ui-icon-triangle-1-e");A(o)}z(g,"click",function(){if(ma(q,"ui-icon-triangle-1-s")){ka(q,"ui-icon-triangle-1-s","ui-icon-triangle-1-e");A(o)}else{ka(q,"ui-icon-triangle-1-e","ui-icon-triangle-1-s");O(o)}})}}j.count==0&&O(j.el);c.li_group[f]=j;j.li.appendChild(d);j.count++;j.title.innerHTML=m+"("+j.count+")"}},_updateOne:function(a){var b=this.li,c=a.id;b[c]&&this._updateInfo(b[c],a)},
update:function(a){a=aa(a);for(var b=0;b<a.length;b++)this._updateOne(a[b])},add:function(a,b){a=aa(a);for(var c=0;c<a.length;c++)this._addOne(a[c],b);this.titleCount()},removeAll:function(){var a=[],b=this.li;for(var c in b)a.push(c);this.remove(a);this.titleCount()},remove:function(a){var b,c,d=this.li,f,g=this.li_group;a=x(a);for(var j=0;j<a.length;j++){b=a[j];if(c=d[b]){this.size--;if(f=g[b]){f.count--;f.count==0&&A(f.el);f.title.innerHTML=f.name+"("+f.count+")"}oa(c);delete d[b]}}this.titleCount()},
select:function(a){(a=this.li[a])&&a.firstChild.click();return a},active:function(a){if(this.options.highlightable){this._actived&&K(this._actived.firstChild,"ui-state-default ui-state-highlight");if(a){if(a=this.li[a]){D(a.firstChild,"ui-state-default ui-state-highlight");this._actived=a}}else this._actived=null}},destroy:function(){}});ca("room",function(a){function b(o,q){var r=o.nick;o=E({},o,{group:"group",nick:r+"("+(parseInt(o.count)+"/"+parseInt(o.all_count||o.count))+")"});g.updateChat(o);
o.blocked&&(o.nick=r+"("+t("blocked")+")");m.li[o.id]?m.update(o):!q&&m.add(o)}var c=this.im,d=c.room,f=c.setting,g=this.layout,j=c.buddy,m=this.room=(new webim.ui.room(null,E(a,{buddy:j,user:c.data.user}))).bind("select",function(o,q){g.addChat("room",q.id);g.focusChat("room",q.id)}).bind("discussion",function(o,q,r){q.id=q.id||M();d.join(q.id,q.nick,function(){g.addChat("room",q.id);g.focusChat("room",q.id)});for(o=0;o<r.length;o++){var s=r[o];(function(w,C){setTimeout(function(){c.sendMessage(w)},
C*500)})({type:"chat",to:s,from:c.data.user.id,nick:c.data.user.nick,to_nick:j.get(s)&&j.get(s).nick,timestamp:(new Date).getTime(),body:"webim-event:invite|,|"+q.id+"|,|"+q.nick},o)}}).bind("exit",function(o,q){d.block(q);g.removeChat("room",q)});c.bind("event",function(o,q){for(var r=0;r<q.length;r++){var s=q[r].event;s&&s[0]=="invite"&&d.join(s[1],s[2],function(){})}});g.addWidget(m,{title:t("room"),icon:"room",sticky:c.setting.get("buddy_sticky"),onlyIcon:true,isMinimize:true});c.setting.bind("update",
function(o,q,r){if(q=="buddy_sticky")m.window.options.sticky=r});d.bind("join",function(o,q){b(q);if(q.temporary){for(var r=[],s=f.get("temporary_rooms")||[],w=false,C=false,R=0;R<s.length;R++){if(s[R].id==q.id){w=true;C=s[R].nick!=q.nick;s[R].nick=q.nick}r.push(s[R])}w||r.push({id:q.id,nick:q.nick});if(!w||C)f.set("temporary_rooms",r)}}).bind("leave",function(o,q){if(q.temporary){for(var r=[],s=f.get("temporary_rooms")||[],w=false,C=0;C<s.length;C++)if(s[C].id==q.id)w=true;else r.push(s[C]);w&&f.set("temporary_rooms",
r);m.remove(q.id)}}).bind("block",function(o,q,r){o=d.get(q);f.set("blocked_rooms",r);b(o);d.leave(q)}).bind("unblock",function(o,q,r){o=d.get(q);f.set("blocked_rooms",r);b(o);d.join(q,o&&o.nick)}).bind("addMember",function(o,q){b(d.get(q),true)}).bind("removeMember",function(o,q){b(d.get(q),true)});A(m.$.actions);c.bind("beforeOnline",function(){}).bind("online",function(){O(m.$.actions)}).bind("offline",function(){A(m.$.actions);m.removeAll()});return m});Q("room",{template:'<div id="webim-room" class="webim-room webim-flex webim-box">\t<div id=":list">\t<div id=":search" class="webim-room-search ui-state-default ui-corner-all"><em class="ui-icon ui-icon-search"></em><input id=":searchInput" type="text" value="" /></div>\t<div class="webim-room-content webim-flex">\t<div id=":empty" class="webim-room-empty"><%=empty room%></div>\t<ul id=":ul"></ul>\t</div>\t</div>\t<div id=":discussion" style="display:none;" class="webim-room-discussion">\t<h4><%=discussion%></h4>\t<div><p><%=discussion name%></p><input id=":name" class="webim-room-discussion-name" type="text" /></div>\t<div><p><%=select discussion buddies%></p><ul class="webim-room-discussion-list ui-widget-content" id=":ul2"></ul></div>\t<div><a id=":confirm" href="#" class="webim-button ui-state-default ui-corner-all"><%=confirm%></a><a id=":cancel" href="#" class="webim-button ui-state-default ui-corner-all"><%=cancel%></a></div>\t</div>\t<div id=":actions" class="webim-room-actions"><a id=":create" href="#" class="webim-button ui-state-default ui-corner-all"><%=create discussion%></a></div>\t</div>',
tpl_li:'<li title=""><input class="webim-button ui-state-default ui-corner-all" type="button" value="<%=exit%>" /><input class="webim-button ui-state-default ui-corner-all" type="button" value="<%=invite%>" /><a href="<%=url%>" rel="<%=id%>" class="ui-helper-clearfix"><div id=":tabCount" class="webim-window-tab-count">0</div><img width="25" src="<%=pic_url%>" defaultsrc="<%=default_pic_url%>" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" /><strong><%=nick%></strong></a></li>'},
{_init:function(){this.size=0;this.li={};this._count=0;O(this.$.empty);this.options.discussion||A(this.$.create)},_initEvents:function(){var a=this,b=a.$,c=b.search,d=b.searchInput,f=t("search room");z(c.firstChild,"click",function(){d.focus()});d.value=f;z(d,"focus",function(){D(c,"ui-state-active");if(this.value==f)this.value=""});z(d,"blur",function(){K(c,"ui-state-active");if(this.value=="")this.value=f});z(d,"keyup",function(){var g=this.value;H(a.li,function(j,m){g&&(m.text||m.innerHTML.replace(/<[^>]*>/g,
"")).indexOf(g)==-1?A(m):O(m)})});z(b.create,"click",function(g){I(g);a.updateDiscussion()});z(b.confirm,"click",function(g){I(g);a.confirmDiscussion()});z(b.cancel,"click",function(g){I(g);a.confirmDiscussion(true)})},scroll:function(a){fa(this.element,"webim-room-scroll",a)},_updateInfo:function(a,b){a=a.firstChild.nextSibling.nextSibling;a.setAttribute("href",b.url);a=a.firstChild.nextSibling;a.setAttribute("defaultsrc",b.default_pic_url?b.default_pic_url:"");a.setAttribute("src",b.pic_url);a=
a.nextSibling;a.innerHTML=b.nick;return a},_addOne:function(a){var b=this,c=b.li,d=a.id,f=b.$.ul;b.size++;if(!c[d]){if(!a.default_pic_url)a.default_pic_url="";c=c[d]=N(T(b.options.tpl_li,a));var g=c.firstChild,j=c.firstChild.nextSibling;if(a.temporary){z(g,"click",function(m){I(m);b.trigger("exit",[d])});z(j,"click",function(m){I(m);b.updateDiscussion(a)})}else{A(j);A(g)}z(j.nextSibling,"click",function(m){I(m);b.showCount(d,0);b.trigger("select",[a]);this.blur()});f.appendChild(c)}},_updateOne:function(a){var b=
this.li,c=a.id;b[c]&&this._updateInfo(b[c],a)},update:function(a){a=aa(a);for(var b=0;b<a.length;b++)this._updateOne(a[b])},add:function(a){A(this.$.empty);a=aa(a);for(var b=0;b<a.length;b++)this._addOne(a[b]);this.size>8&&this.scroll(true)},removeAll:function(){var a=[],b=this.li;for(var c in b)a.push(c);this.remove(a)},remove:function(a){var b,c,d=this.li;a=x(a);for(var f=0;f<a.length;f++){b=a[f];if(c=d[b]){oa(c);delete d[b]}}},select:function(a){(a=this.li[a])&&a.firstChild.click();return a},destroy:function(){},
confirmDiscussion:function(a){var b=this.$;A(b.discussion);O(b.list);O(b.actions);if(!a){a=this._discussion||{};a.temporary=true;a.nick=b.name.value||t("discussion");b=b.ul2.getElementsByTagName("input");for(var c=[],d=0;d<b.length;d++){var f=b[d];f.checked&&c.push(f.value)}this.trigger("discussion",[a,c])}},updateDiscussion:function(a){var b=[],c=this.options.buddy.all(true);this._discussion=a;var d=this.$;d.name.value=a&&a.nick.replace(/\([^\)]*\)/ig,"")||t("discussion name input",{name:this.options.user.nick});
for(a=0;a<c.length;a++){var f=c[a];b.push('<li><label for="webim-discussion-'+f.id+'"><input id="webim-discussion-'+f.id+'" type="checkbox" name="buddy" value="'+f.id+'" />'+f.nick+"</label></li>")}d.ul2.innerHTML=b.join("");O(d.discussion);A(d.list);A(d.actions)},showCount:function(a,b){var c=this.li;c[a]&&ja(c[a].firstChild.nextSibling.nextSibling.firstChild,b)},active:function(a){if(this.options.highlightable){this._actived&&K(this._actived.firstChild.nextSibling,"ui-state-default ui-state-highlight");
if(a){if(a=this.li[a]){D(a.firstChild.nextSibling,"ui-state-default ui-state-highlight");this._actived=a}}else this._actived=null}}});ca("menu",function(a){var b=this.layout;a=this.menu=new u.menu(null,a);b.addWidget(a,{title:t("menu"),icon:"home",sticky:false,onlyIcon:false,isMinimize:true},null,"shortcut")});Q("menu",{template:'<div id="webim-menu" class="webim-menu">\t\t<ul id=":ul"><%=list%></ul>\t\t\t<div id=":empty" class="webim-menu-empty"><%=empty menu%></div>\t\t\t\t</div>',tpl_li:'<li><a href="<%=link%>" target="<%=target%>"><img src="<%=icon%>"/><span><%=title%></span></a></li>'},
{_init:function(){var a=this.options;a.data&&a.data.length&&A(this.$.empty)},template:function(){var a=this,b=[],c=a.options.data;c&&H(c,function(d,f){b.push(a._li_tpl(f))});return T(a.options.template,{list:b.join("")})},_li_tpl:function(a){return T(this.options.tpl_li,{title:t(a.title),icon:a.icon,link:a.link,target:a.isExtlink?"_blank":""})},_fitUI:function(){var a=this.element;if(a.clientHeight>300)a.style.height="300px"},add:function(a){var b=this;if(G(a))H(a,function(d,f){b.add(f)});else{var c=
b.$;A(c.empty);c.ul.appendChild(N(b._li_tpl(a)))}},destroy:function(){}});ca("chatlink",function(a){var b=this,c=b.im,d=b.chatlink=(new webim.ui.chatlink(null,a)).bind("select",function(j,m){b.layout.addChat("buddy",m);b.layout.focusChat("buddy",m)}),f=function(j){return j.show!="invisible"&&j.presence=="online"},g=function(j){return j.show=="invisible"};c.buddy.bind("online",function(j,m){d.add(S(m,f))}).bind("update",function(j,m){d.add(S(m,f));d.remove(S(m,g))}).bind("offline",function(j,m){d.remove(m)});
c.bind("beforeOnline",function(j,m){m.stranger_ids=d.idsArray()}).bind("online",function(){d.remove(c.data.user)}).bind("offline",function(){d.removeAll()})});Q("chatlink",{link_href:[/space\.php\?uid=(\d+)$/i,/space\-(\d+)\.html$/i,/space\-uid\-(\d+)\.html$/i,/\?mod=space&uid=(\d+)$/,/\?(\d+)$/],space_href:[/space\.php\?uid=(\d+)$/i,/space\-(\d+)\.html$/i,/space\-uid\-(\d+)\.html$/i,/\?mod=space&uid=(\d+)/,/\?(\d+)$/],space_class:/spacemenu_list|line_list|xl\sxl2\scl/i,space_id:/profile_act/i,link_class:null,
off_link_class:null,link_wrap:null,space_wrap:null},{_init:function(){function a(U,ba){if(!U)return false;if(!ba)return false;for(var Z=ba.length,da=0;da<Z;da++){var Da=ba[da].exec(U);if(Da&&Da[1])return Da[1]}return false}var b=this.list={},c=this.options,d=this.anthors={},f=c.link_href,g=c.space_href,j=c.space_id,m=c.off_link_class,o=c.link_class,q=c.space_class,r=c.space_wrap||B;(c=(c.link_wrap||B).getElementsByTagName("a"))&&H(c,function(U,ba){var Z=a(ba.href,f),da=ba.innerHTML;if(Z&&sa(ba.firstChild).length==
0&&da&&(!ba.className||!o||o.test(ba.className))&&(!ba.className||!m||!m.test(ba.className))){d[Z]?d[Z].push(ba):d[Z]=[ba];b[Z]={id:Z,name:da}}});if(g=a(y.location.href,g)){b[g]=E(b[g],{id:g});r=r.getElementsByTagName("*");c=r.length;for(var s,w,C,R=0;R<c;R++){s=r[R];w=s.className;C=s.id;if(q&&q.test(w)||j&&j.test(C)){s=sa(s.firstChild);if(s.length){s=s[s.length-1];d[g]?d[g].push(s):d[g]=[s]}break}}}},_temp:function(a){var b=this;a=N(T('<a id="<%=id%>" href="#chat" title="<%=title%>" class="webim-chatlink"><%=text%></a>',
a));z(a,"click",function(c){b.trigger("select",this.id);na(c);I(c)});return a},idsArray:function(){var a=[];H(this.list,function(b){a.push(b)});return a},add:function(a){var b=this.list,c=this.anthors,d=a.length,f,g,j,m,o;for(f=0;f<d;f++){g=a[f];if(g.id&&(j=g.uid||g.id)&&(m=b[j])){o=c[j];if(!m.elements&&o){m.elements=[];for(var q=0;q<o.length;q++)if(o[q].tagName.toLowerCase()=="li"){m.elements[q]=B.createElement("li");m.elements[q].appendChild(this._temp({id:g.id,title:"",text:t("chat with me")}))}else m.elements[q]=
this._temp({id:g.id,title:t("chat with",{name:m.name}),text:""})}o&&H(o,function(r,s){s.parentNode.insertBefore(m.elements[r],s.nextSibling)})}}},remove:function(a){var b=this.list,c=a.length,d,f,g,j;for(d=0;d<c;d++){f=a[d];if(f.id&&(g=f.uid||f.id)&&(j=b[g]))j.elements&&H(j.elements,function(m,o){oa(o)})}},removeAll:function(){H(this.list,function(a,b){b.elements&&H(b.elements,function(c,d){oa(d)})})}});ca("chatbtn",function(a){var b=this,c=b.im,d=b.chatbtn=(new webim.ui.chatbtn(null,a)).bind("select",
function(j,m){b.im.online();m=m.substr(13);b.layout.addChat("buddy",m);b.layout.focusChat("buddy",m);if(a&&a.autoInsertlink){var o=b.layout.chat("buddy",m);o&&o.insert(y.location.href)}}),f=function(j){return j.show!="invisible"&&j.presence=="online"},g=function(j){return j.show=="invisible"};c.buddy.bind("online",function(j,m){d.on(S(m,f))}).bind("update",function(j,m){d.on(S(m,f));d.off(S(m,g))}).bind("offline",function(j,m){d.off(m)});c.bind("beforeOnline",function(j,m){m.stranger_ids=d.idsArray()}).bind("online",
function(){d.off(c.data.user)}).bind("offline",function(){d.offAll()})});Q("chatbtn",{wrap:null,re_id:[/chat\/([^\/]+)/i],elementId:null,className:/webim-chatbtn/},{_init:function(){function a(o,q){if(!o)return false;if(!q)return false;for(var r=q.length,s=0;s<r;s++){var w=q[s].exec(o);if(w&&w[1])return w[1]}return false}var b=this,c=b.list={},d=b.options,f=b.anthors={},g=d.re_id,j=d.elementId,m=d.className;d=d.wrap||B;if(j)d=(d=B.getElementById(j))?[d]:null;else d=d.getElementsByTagName("a");d&&
H(d,function(o,q){var r=a(q.href,g),s=q.innerHTML;if(r&&sa(q.firstChild).length==0&&s&&(j||m.test(q.className))){f[r]?f[r].push(q):f[r]=[q];c[r]={id:r,name:s};s=N('<i class="webim-chaticon"><em>');q.appendChild(s);q.icon=s;q.title=t("offline");q.id="webim-chatid-"+r;z(q,"click",function(w){b.trigger("select",this.id);na(w);I(w)})}})},idsArray:function(){var a=[];H(this.list,function(b){a.push(b)});return a},on:function(a){var b=this.list,c=this.anthors,d=a.length,f,g,j;for(f=0;f<d;f++){g=a[f];if(g.id&&
(j=g.uid||g.id)&&b[j])if(g=c[j])for(var m=0;m<g.length;m++){var o=g[m];o&&o.icon&&D(o.icon,"webim-chaticon-online");o&&(o.title=t("available"))}}},off:function(a){var b=this.list,c=this.anthors,d=a.length,f,g,j;for(f=0;f<d;f++){g=a[f];if(g.id&&(j=g.uid||g.id)&&b[j])if(g=c[j])for(var m=0;m<g.length;m++){var o=g[m];o&&o.icon&&K(o.icon,"webim-chaticon-online");o&&(o.title=t("unavailable"))}}},offAll:function(){H(this.anthors,function(a,b){b&&H(b,function(c,d){d&&d.icon&&K(d.icon,"webim-chaticon-online");
d&&(d.title=t("unavailable"))})})}});Ga("notification",{url:"webim/notifications"},{_init:function(){},grep:function(a){return a&&a.text},handle:function(a){a=S(aa(a),this.grep);a.length&&this.trigger("data",[a])},load:function(){X({url:ga("notifications"),cache:false,context:this,success:this.handle})}});ca("notification",function(a){var b=this.im,c=this.layout,d=this.notification=new u.notification(null,a),f=b.notification=new webim.notification(null,{jsonp:b.options.jsonp});c.addWidget(d,{title:t("notification"),
icon:"notification",sticky:false,onlyIcon:true,isMinimize:true});f.bind("data",function(g,j){d.window.notifyUser("information","+"+j.length);d.add(j)});setTimeout(function(){f.load()},2E3)});Q("notification",{template:'<div id="webim-notification" class="webim-notification">\t<ul id=":ul"><%=list%></ul>\t<div id=":empty" class="webim-notification-empty"><%=empty notification%></div>\t</div>',tpl_li:'<li><a href="<%=link%>" target="<%=target%>"><%=text%></a></li>'},{_init:function(){var a=this.options;
a.data&&a.data.length&&A(this.$.empty)},template:function(){var a=this,b=[],c=a.options.data;c&&H(c,function(d,f){b.push(a._li_tpl(f))});return T(a.options.template,{list:b.join("")})},_li_tpl:function(a){return T(this.options.tpl_li,{text:a.text,link:a.link,target:this.options.target||a.target||""})},_fitUI:function(){var a=this.element;if(a.clientHeight>300)a.style.height="300px"},add:function(a){var b=this;if(G(a))H(a,function(d,f){b.add(f)});else{var c=b.$;A(c.empty);c.ul.appendChild(N(b._li_tpl(a)))}},
destroy:function(){}});ca("layout.popup",function(a){u.buddy&&(u.buddy.defaults.highlightable=true);u.room&&(u.room.defaults.highlightable=true);u.chat&&(u.chat.defaults.simple=true);a=a||{};var b=this.im,c=b.buddy,d=b.history,f=b.status,g=b.room,j=new u["layout.popup"](null,E({},a,{ui:this}));(function(){b.bind("online",function(m,o){j.options.user=o.user;j.updateAllChat()}).bind("offline",function(){j.updateAllChat()})})();(function(){b.bind("beforeOnline",function(q,r){E(r,{buddy_ids:f.get("_cacheBuddy"),
room_ids:"",show:"available"})});var m=function(q){return q&&q.id},o=function(){var q=Ba(c.all(true),m);f.set("_cacheBuddy",q.join(","));j.updateAllChat()};c.bind("online",o).bind("offline",o)})();(function(){g.bind("addMember",function(m,o,q){(m=j.chat("room",o))&&m.addMember(q.id,q.nick,q.id==b.data.user.id)}).bind("removeMember",function(m,o,q){(m=j.chat("room",o))&&m.removeMember(q.id,q.nick)})})();(function(){d.bind("chat",function(m,o,q){(m=j.chat("chat",o))&&m.history.add(q)});d.bind("grpchat",
function(m,o,q){(m=j.chat("grpchat",o))&&m.history.add(q)});d.bind("clear",function(m,o,q){(m=j.chat(o,q))&&m.history.clear()})})();b.bind("message",function(m,o){for(var q=false,r=o.length,s,w=b.data.user.id,C,R,U=0;U<r;U++){s=o[U];C=s.id;type=s.type==="chat"?"buddy":"room";(R=j.chat(type,C))&&R.status("");if(!R){(R=j.widget(type))&&R.showCount(C,"+1");j.notifyUser(type,"+1")}if(s.from!=w)q=true}if(q){pa.play("msg");wa(t("new message"),5)}});b.bind("status",function(m,o){H(o,function(q,r){var s=
b.data.user.id,w=r.from;if(!(s!=r.to&&s!=r.from))(s=j.chat("buddy",w))&&s.status(r.show)})});return j});Q("layout.popup",{template:'<div id="webim" class="webim webim-state-ready">\t<div class="webim-preload ui-helper-hidden-accessible">\t<div id="webim-flashlib-c">\t</div>\t</div>\t<div id=":layout" class="webim-layout webim-popup ui-helper-clearfix"><div id=":left" class="webim-popup-left"></div><div id=":right" class="webim-popup-right"></div>\t<div id=":widgets" class="webim-widgets ui-widget-content ui-helper-clearfix"><div class="webim-layout-bg ui-state-default ui-toolbar"></div></div>\t</div>\t</div>',
template_tab:'<div class="webim-window-tab-wrap">\t<div id=":tab" class="webim-window-tab ui-state-default">\t<div class="webim-window-tab-inner">\t<div id=":tabTip" class="webim-window-tab-tip">\t<strong id=":tabTipC"><%=title%></strong>\t</div>\t<div id=":tabCount" class="webim-window-tab-count">\t0\t</div>\t<em id=":tabIcon" class="webim-icon webim-icon-<%=icon%>"></em>\t</div>\t</div>\t</div>'},{_init:function(){E(this,{widgets:{},widgetIds:[],tabs:{},activeTabId:null});this.win=new u.window(null,
{closeable:false,minimizable:false,isMinimize:false})},buildUI:function(){var a=this.win;a.$.window.appendChild(this.$.widgets);this.$.left.appendChild(a.element)},widget:function(a){return this.widgets[a]},addWidget:function(a,b){var c=this.win,d=a.name;a.window=c;this.widgetIds.push(d);this.widgets[a.name]=a;A(a.element);c.$.content.appendChild(a.element);this._createTab(d,b);this.widgetIds.length==1&&this._activeTab(d)},_createTab:function(a,b){var c=this,d=N(T(c.options.template_tab,b));d.$=L(d);
var f=d.$.tab;z(f,"click",function(g){c._activeTab(a);na(g);I(g)});z(f,"mouseover",function(){D(this,"ui-state-hover");K(this,"ui-state-default")});z(f,"mouseout",function(){K(this,"ui-state-hover");this.className.indexOf("ui-state-")==-1&&D(this,"ui-state-default")});W(f);c.$.widgets.appendChild(d);c.tabs[a]=d},_activeTab:function(a){for(var b=this.tabs,c=this.widgetIds.length-1;c>=0;c--){var d=this.widgetIds[c],f=this.widgets[d],g=b[d].$.tab;if(d==a){O(f.element);D(g,"ui-state-active");K(g,"ui-state-default");
ja(b[d].$.tabCount,0)}else if(d==this.activeTabId){A(f.element);D(g,"ui-state-default");K(g,"ui-state-active")}}this.activeTabId=a},notifyUser:function(a,b){if(a!=this.activeTabId){var c=this.tabs[a];c&&ja(c.$.tabCount,b)}},focusChat:function(){},chat:function(a,b){if(!a||this.__chat&&this.__chat.__id==V(a,b))return this.__chat;return null},updateChat:function(){var a=this.chat();a&&a.update()},updateAllChat:function(){this.updateChat()},addChat:function(a,b,c,d,f){a=ha(a);var g=this;g.__chat&&oa(g.__chat.window.element);
var j=g.widget(a=="room"?"buddy":"room");j&&j.active(null);(j=g.widget(a))&&j.active(b);var m=(new u.window(null,E({minimizable:false},d))).bind("close",function(){g.__chat=null;j&&j.active()});c=g.__chat=g.options.ui.addApp("chat",E({},g.options.ui.options[a+"ChatOptions"],{id:b,type:a,nick:f,winOptions:d},c));c.__id=V(a,b);c.setWindow(m);g.$.right.appendChild(m.element)}})})(window,document);
